---
title: "Caloosahatchee and Okeechobee Conditions Report <img src='horiz_SCCF_Logo.png' align='right' height = '100'/>"
output: 
  html_document: 
    toc: yes
    self_contained: true
    includes:
      after_body: footer.html
editor_options: 
  chunk_output_type: console
---

<!-- <style type="text/css"> -->
<!-- font-family: Arial -->
<!-- </stlye> -->

<!-- if stuck git push -f origin -->

<!-- git help https://medium.com/analytics-vidhya/tutorial-removing-large-files-from-git-78dbf4cf83a -->

***

```{r date,echo=FALSE,message=FALSE,warning=FALSE}
up.date=format(Sys.time(),tz="America/New_York",usetz=T,"%F %R")
up.date=as.POSIXct(up.date,tz="America/New_York")

dst.check=lubridate::dst(as.POSIXct(up.date))

```

`r paste("Updated:",up.date, ifelse(dst.check==T,"EDT","EST"))`

<!-- ![](https://github.com/sccf-tech/CRE_Conditions/actions/workflows/RegionalReport.yaml/badge.svg) -->

***

## Purpose

This webpage/report is intended to aggregate information from different agencies (i.e. USACE, SFWMD, FWC, USGS and NOAA) into one spot to help inform local government agencies and stakeholders on conditions within Lake Okeechobee, the Caloosahatchee River and Estuary and Coastal southwest Florida. The data provided here should be considered preliminary and are subject to change. 

***

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,
                      message=FALSE,
                      warning=FALSE,
                      fig.path="plots/")

## Libraries
library(AnalystHelper)
library(reshape)
library(plyr)
library(zoo)
library(rvest)
library(lubridate)
library(flextable)
library(magrittr)
library(grid)
library(RcppRoll)
library(downloadthis)
library(dataRetrieval)

library(jsonlite)
library(sp)
library(rgdal)
library(rgeos)
# library(tmap)
library(httr)
library(raster)
##
wgs84=CRS("+init=epsg:4326")
utm17=CRS("+init=epsg:26917")
# tmap_mode("view")
###
dates=seq(date.fun(date.fun(Sys.Date())-ddays(13)),date.fun(Sys.Date()),"1 days")

#### GIS data
# shore=spTransform(readOGR("C:/Julian_LaCie/_GISData/FWC","FWC_Shoreline_simp"),wgs84)
shore=readOGR("./GISData","FWC_Shoreline_simp") 
shore=spTransform(shore,wgs84)

# lakeO=readOGR("C:/Julian_LaCie/_GitHub/CRE_Conditions/report/GISData","LakeOkeechobee_general")
lakeO=readOGR("./GISData","LakeOkeechobee_general")
lakeO=spTransform(lakeO,utm17)

# lakeO.lit=readOGR("C:/Julian_LaCie/_GitHub/CRE_Conditions/report/GISData","LOK_littoral")
lakeO.lit=readOGR("./GISData","LOK_littoral")
lakeO.lit=spTransform(lakeO.lit,utm17)

# test2=readOGR("C:/Julian_LaCie/_GISData/LakeOkeechobee/Littoral","LAKEO_LITTORALZONE_VEG2007")
# test2=gBuffer(lakeO.lit,width=100)
# test2=SpatialPolygonsDataFrame(test2,data.frame(buffer=100,row.names = "buffer"))
# test2=crop(test2,lakeO)
# writeOGR(test2,"C:/Julian_LaCie/_GitHub/CRE_Conditions/report/GISData","LOK_littoral",driver="ESRI Shapefile",overwrite_layer = T)

# Functions
decdate.fun=function(date){
  Y=as.numeric(format(date,"%Y"))
  start=date.fun(paste(Y,1,1,sep="-"))
  end=date.fun(paste(Y+1,1,1,sep="-"))
  sofar <- as.numeric(difftime(date, start, units = "secs"))
  total <- as.numeric(difftime(end, start, units = "secs"))
  Y + sofar / total
}
ci.reverse.scaling.fun=function(DN){
  10^(3.0 / 250.0 * DN - 4.2)
}
ci.scaling.fun=function(ci){
  round(83.3 * (log10(ci[ci>0]) + 4.2))
}
recon.dat.fun=function(date_min,date_max,param,site,UTC=TRUE,print.link=TRUE){
  ## Stop functions for date, site and parameters
  if(date_max<date_min){stop("Check dates, max date can be before min date.")}
  if(!(site%in%c(13,51,16,56,18,53,11,55))){stop("Check site ID")}
  # WQ params only - Nevermind need to develop further.
  # param.vals=c("cdom","temperature","chlorophyll","turbibity",
  #              "conductivity","oxygen","depth","oxygen_sat",
  #              "oxygen_percent","nitrate","nitrate_abs_254","nitrate_abs_350",
  #              "phosphate","voltage")
  RECON.sites=data.frame(ID=c(13,51,16,56,18,53,11,55),
          name=c("Shell Point","Redfish Pass","GOM","McIntyre Creek",
                 "Beautiful Island","Fort Myers","Tarpon Bay","Wave Buoy"))
  servfull <- "http://recondata.sccf.org/cgi-data/nph-data.cgi"
  utc.val=if(UTC==TRUE){"?x=utc_date"}
  param.val=paste(param,collapse=",")
  date_min <- format(date_min,"%Y%m%d")
  date_max <- format(date_max,"%Y%m%d")
  
  link=paste0(servfull,utc.val,"&amp;y=",param.val,"&amp;min_date=",date_min,"&amp;max_date=",date_max,"&amp;node=",site,"&amp;data_format=text")
  report=read.table(link,skip=1,sep = '\t',header=T)
  colnames(report) = c("Date.EST",param,"Date.UTC")
  report$Date.EST=as.POSIXct(strptime(report$Date.EST,"%F%X"),tz="EST")
  report$Date.UTC=as.POSIXct(strptime(report$Date.UTC,"%F%X"),tz="UTC")
  report$SiteName=subset(RECON.sites,ID==site)$name
  report$SiteID=site
  if(print.link==TRUE){message(link)}
  return(report)
  
}
```


## USACE Data Summary

```{r data, include=F}
## Lake Okeechobee Report
LO.url="https://w3.saj.usace.army.mil/h2o/reports/r-oke.html"
# download.file(LO.url, destfile = "LOK_scrapedpage.html", quiet=TRUE)
webpage=read_html(LO.url)
node.val=html_nodes(webpage,"pre")

LO.text.vals=html_text(node.val)
LO.report=strsplit(as.character(LO.text.vals),"\n")
LO.report

grep("*Okeechobee Lake Elevation",LO.report[[1]])


tmp1=data.frame(t(sapply(strsplit(LO.report[[1]][266:279],"\\s+"),c)))
colnames(tmp1)=c("day","month","year","S77","S77_ds","S78","S79")
tmp1$Date=with(tmp1,date.fun(paste(year,month,day),form="%Y %B %d"))
tmp1[,4:7]=sapply(tmp1[,4:7],as.numeric)

tmp2=data.frame(t(sapply(strsplit(LO.report[[1]][285:298],"\\s+"),c)))
colnames(tmp2)=c("day","month","year","S310","S351","S352","S354","L8")
tmp2$Date=with(tmp2,date.fun(paste(year,month,day),form="%Y %B %d"))
tmp2[,4:8]=sapply(tmp2[,4:8],as.numeric)

tmp3=data.frame(t(sapply(strsplit(LO.report[[1]][304:317],"\\s+"),c)))
colnames(tmp3)=c("day","month","year","S308","S308_ds","S80")
tmp3$Date=with(tmp3,date.fun(paste(year,month,day),form="%Y %B %d"))
tmp3[,4:6]=sapply(tmp3[,4:6],as.numeric)

q.dat=cbind(tmp1[,c(8,4:7)],tmp2[,c(4:8)],tmp3[,c(4:6)])

## Preferred Structures
str.url="https://w3.saj.usace.army.mil/h2o/reports/r-lonin.html"
# download.file(str.url, destfile = "struct_scrapedpage.html", quiet=TRUE)
webpage=read_html(str.url)
node.val=html_nodes(webpage,"pre")

str.text.vals=html_text(node.val)
str.report=strsplit(as.character(str.text.vals),"\n")
str.report

pref.struct=data.frame(t(sapply(strsplit(str.report[[1]][21:34],"\\|"),c)))
pref.struct
colnames(pref.struct)=c("Date","LONIN_cfs","STORAGE_cfs","S77","S308","S351","S352","S354","L8")
pref.struct[,2:9]=sapply(pref.struct[,2:9],as.numeric)
pref.struct$Date=date.fun(pref.struct$Date,form="%d %B %Y")
pref.struct[,2:9]=cfs.to.acftd(pref.struct[,2:9])

## Discharge data for lake and estuaries
q.dat=merge(pref.struct[,c("Date","S77","S308","L8",'S351',"S352","S354")],
q.dat[,c("Date","S78","S79","S310","S80")],"Date")

## Maps and Archived data
map.q=data.frame()
map.stg=data.frame()
for(i in 1:(length(dates)-1)){
  map.url=paste0("https://w3.saj.usace.army.mil/h2o/reports/StatusDaily/archive/",format(dates[i],"%m%d"),"/StatusDaily.htm")
  # download.file(map.url, destfile = "map_dat.html", quiet=TRUE)
  mapdata=readLines(map.url)
  val=grep("CA1IN",mapdata)
  WCA1=strsplit(strsplit(mapdata[val],"\\s+")[[1]][13],"</div>")[[1]][1]
  
  val=grep("CA2IN",mapdata)
  WCA2=strsplit(strsplit(mapdata[val],"\\s+")[[1]][13],"</div>")[[1]][1]
  
  val=grep("CA3IN",mapdata)
  WCA3=strsplit(strsplit(mapdata[val],"\\s+")[[1]][13],"</div>")[[1]][1]
  
  val=grep("S12",mapdata)
  S12s=as.numeric(strsplit(strsplit(mapdata[val],"\\s+")[[1]][8],"</div>")[[1]][1])
  
  val=grep("S333",mapdata)
  S333=as.numeric(strsplit(mapdata[val],"<br>|\\s+")[[1]][12])
  S333N=as.numeric(strsplit(strsplit(mapdata[val],"<br>|\\s+")[[1]][14],"</div>")[[1]][1])
  
  val=grep("S356",mapdata)
  S356=as.numeric(strsplit(strsplit(mapdata[val],"\\s+")[[1]][8],"</div>")[[1]][1])
  
  ENP=S12s+(S333+S333N)-S356
  
  val=grep("Istokpoga</a>",mapdata)
  Istok=strsplit(strsplit(mapdata[val],"\\s+")[[1]][6],"</div>")[[1]][1]
  
  val=grep("S-65E</a>",mapdata)
  S65E=strsplit(strsplit(mapdata[val],"\\s+")[[1]][6],"<br>")[[1]][1]
  
  val=grep("S-65EX1</a>",mapdata)
  S65EX1=strsplit(strsplit(mapdata[val],"\\s+")[[1]][6],"<br>")[[1]][1]
  
  val=grep("Fisheating Creek",mapdata)
  FEC=strsplit(strsplit(mapdata[val],"\\s+")[[1]][7],"</div>")[[1]][1]
  
  val=grep("/plots/s79h.pdf",mapdata)
  S79=strsplit(strsplit(mapdata[val],"\\s+")[[1]][6],"</a>")[[1]][1]
  
  val=grep("/plots/s78h.pdf",mapdata)
  S78=strsplit(strsplit(mapdata[val],"\\s+")[[1]][6],"</a>")[[1]][1]
  
  val=grep("/plots/s77",mapdata)
  S77=strsplit(strsplit(mapdata[val],"\\s+")[[1]][6],"</a>")[[1]][1]
  
  val=grep("../plots/ok8hhp.pdf",mapdata)
  LakeStage=as.numeric(strsplit(mapdata[val[1]],"\\s+")[[1]][6])
  
  # date.val=dates[i]-ddays(1)
  date.val=dates[i]
  rslt=data.frame(Date=date.val,
                  FEC=as.numeric(FEC),
                  Istok=as.numeric(Istok),
                  S65E=as.numeric(S65E),
                  S65EX1=as.numeric(S65EX1),
                  WCA1=as.numeric(WCA1),
                  WCA2=as.numeric(WCA2),
                  WCA3=as.numeric(WCA3),
                  ENP=as.numeric(ENP),
                  S79.map=as.numeric(S79),
                  S78.map=as.numeric(S78),
                  S77.map=as.numeric(S77))
  map.q=rbind(map.q,rslt)
  rslt.stg=data.frame(Date=date.val,Stg=as.numeric(LakeStage))
  map.stg=rbind(map.stg,rslt.stg)
  print(i)
}

map.q[,2:ncol(map.q)]=cfs.to.acftd(map.q[,2:ncol(map.q)])

q.dat=merge(q.dat,map.q,"Date")
q.dat$S79=with(q.dat,ifelse(is.na(S79)==T,round(S79.map,0),S79))
q.dat$S78=with(q.dat,ifelse(is.na(S78)==T,round(S78.map,0),S78))
q.dat$S77=with(q.dat,ifelse(is.na(S77)==T,round(S77.map,0),S77))
q.dat
vars=c("Date", "S77", "S308", "L8", "S351", "S352", "S354", "S78", 
"S79", "S310", "S80", "FEC", "Istok", "S65E", "S65EX1", "WCA1", 
"WCA2", "WCA3", "ENP")
q.dat=q.dat[,vars]

# q.dat[q.dat<0]<-NA

q.dat$NthLake=rowSums(q.dat[,c("FEC","Istok","S65E","S65EX1")],na.rm=T)

```

```{r table1}
vars=c("Date","S77","S78","S79","S310","S351","S352","S354","L8","S308","S80","NthLake","WCA1","WCA2","WCA3","ENP")
date.7day=seq(date.fun(date.fun(Sys.Date())-ddays(7)),date.fun(Sys.Date()),"1 days")

q.dat.7day=subset(q.dat,Date%in%date.7day)[,vars]
meanQ=cbind(data.frame(Statistic="Average"),data.frame(t(apply(q.dat.7day[,2:16],2,mean,na.rm=T))))
colnames(meanQ)<-c("Statistic",vars[2:length(vars)])
totalQ=cbind(data.frame(Statistic="Total"),data.frame(t(apply(q.dat.7day[,2:16],2,sum,na.rm=T))))
colnames(totalQ)<-c("Statistic",vars[2:length(vars)])
sumstats=rbind(meanQ,totalQ)

q.dat.7day2=q.dat.7day
q.dat.7day2[,2:16]=q.dat.7day2[,2:16]*0.5041669
q.dat.7day2$Date=as.character(q.dat.7day2$Date)
q.dat.7day2=rbind(q.dat.7day2,data.frame(Date="7-Day-Avg",t(apply(q.dat.7day[,2:16],2,FUN=function(x)mean(x*0.5041669,na.rm=T)))))

meanQ.14=cbind(data.frame(Statistic="Average"),data.frame(t(apply(q.dat[,vars[2:length(vars)]],2,mean,na.rm=T))))
colnames(meanQ.14)<-c("Statistic",vars[2:length(vars)])
totalQ.14=cbind(data.frame(Statistic="Total"),data.frame(t(apply(q.dat[,vars[2:length(vars)]],2,sum,na.rm=T))))
colnames(totalQ.14)<-c("Statistic",vars[2:length(vars)])

sumstats14=rbind(meanQ.14,totalQ.14)


q.dat.7day=q.dat.7day[match(q.dat.7day$Date,rev(q.dat.7day$Date)),]
q.dat=q.dat[match(q.dat$Date,rev(q.dat$Date)),]

cap.val="Daily discharge volume in Acre-Feet per day for the last 14-days. Data Source: USACE"
q.dat[,vars]%>%
  flextable()%>%
  colformat_datetime(j=1,fmt_date="%m-%d")%>%
  colformat_double(j=2:15,big.mark = "",digits=0)%>%
  align(j=2:15,part="all",align="center")%>%
  padding(padding=1,part="all")%>%
  font(fontname="Times New Roman",part="all")%>%
  fontsize(size=10,part="body")%>%
  fontsize(size=12,part="header")%>%
  add_header_lines(values=cap.val)%>%
  align(align="center",part="header")%>%fontsize(size=12,part="header")%>%font(fontname = "Times New Roman",part="all")%>%
  footnote(j=~NthLake,value=as_paragraph(" Includes discharges from Fisheating Creek, S71, S72, S84, S84X, S65E, and S65EX1"),ref_symbols =c(" 1"),part="header")%>%
footnote(j=~ENP,value=as_paragraph(" Estimated as S12s+(S333+S333N)-S356. If no data is present (i.e. -NR-) either S12s, S333s or S356 data is not available."),ref_symbols =c(" 2"),part="header")
  # footnote(i=1,j=1,value=as_paragraph("Negative flow values omitted from this table and statistical summaries below."),ref_symbols =c(" "),part="header")
```


```{r}
q.dat%>%
  download_this(
    output_name = "Discharge7day",
    output_extension = ".xlsx",
    button_label = "Download Discharge as .xlsx",
    button_type = "primary",
    has_icon = TRUE,
    icon = "fa fa-file-excel"
  )
```


```{r}
cap.val="Average and total net discharge volume in Acre-Feet per day for the last 7-days. Data Source: USACE"
sumstats%>%
  flextable()%>%
  colformat_double(j=2:15,big.mark = "",digits=0)%>%
  align(j=2:15,part="all",align="center")%>%
  padding(padding=1,part="all")%>%
  font(fontname="Times New Roman",part="all")%>%
  fontsize(size=10,part="body")%>%
  fontsize(size=12,part="header")%>%
  add_header_lines(values=cap.val)%>%
  align(align="center",part="header")%>%fontsize(size=12,part="header")%>%font(fontname = "Times New Roman",part="all")

```

```{r}
cap.val="Average and total net discharge volume in Acre-Feet per day for the last 14-days. Data Source: USACE"
sumstats14%>%
  flextable()%>%
  colformat_double(j=2:15,big.mark = "",digits=0)%>%
  align(j=2:15,part="all",align="center")%>%
  padding(padding=1,part="all")%>%
  font(fontname="Times New Roman",part="all")%>%
  fontsize(size=10,part="body")%>%
  fontsize(size=12,part="header")%>%
  add_header_lines(values=cap.val)%>%
  align(align="center",part="header")%>%fontsize(size=12,part="header")%>%font(fontname = "Times New Roman",part="all")

```

```{r}
laketotalQ=q.dat.7day[,c("S77","S310","S351","S352","S354","L8","S308")]
q.from.Lake=sum(laketotalQ[laketotalQ>0],na.rm=T)
laketotalQ$EAA=rowSums(laketotalQ[,c("S351","S352","S354")],na.rm=T)
S77q=sum(laketotalQ[laketotalQ$S77>0,c("S77")],na.rm=T)
S77q.per=if(q.from.Lake==0){0}else if((S77q/q.from.Lake)*100<1){"< 1"}else{round((S77q/q.from.Lake)*100,0)}

S308q=sum(laketotalQ[,c("S308")],na.rm=T)
S308q.pos=sum(laketotalQ[laketotalQ$S308>0,c("S308")],na.rm=T)
S308q.per=ifelse(S308q<0,NA,round((S308q/q.from.Lake)*100,0))

S310q=sum(laketotalQ[,c("S310")],na.rm=T)
S310q.pos=sum(laketotalQ[laketotalQ$S310>0,c("S310")],na.rm=T)
S310q.per=ifelse(S310q<0,NA,round((S310q/q.from.Lake)*100,0))

L8q=sum(laketotalQ[,c("L8")],na.rm=T)
L8q.pos=sum(laketotalQ[laketotalQ$L8>0,c("L8")])
L8q.per=ifelse(L8q<0,NA,round((L8q/q.from.Lake)*100,0))

EAAq=sum(laketotalQ[,c("EAA")],na.rm=T)
EAAq.pos=sum(laketotalQ[laketotalQ$EAA>0,c("EAA")],na.rm=T)
EAAq.per=ifelse(EAAq<0,NA,round((EAAq/q.from.Lake)*100,0))


laketotalQ2=q.dat.7day[,c("S77","S310","S351","S352","S354","L8","S308")]
tmp=apply(laketotalQ2,2,min,na.rm=T)
v=names(tmp[tmp<0])
v[v=="L8"]="C10A"
v.val=knitr::combine_words(v)

q.BF.Lake=sum(abs(laketotalQ2[laketotalQ2<0]),na.rm=T)
q.in.Lake=sum(q.dat.7day[,"NthLake"],na.rm=T)
```

<!-- **Lake Flows:** In the past 7 days **`r format(round(q.from.Lake,0),big.mark=",")` AF** was discharged from Lake Okeechobee `r  ifelse(length(laketotalQ[laketotalQ<0])>0,paste0("(",format(round(sum(laketotalQ[laketotalQ<0],na.rm=T)*-1,0),big.mark=",")," AF return to the Lake via backflow)"),"")`, with **`r format(round(S77q,0),big.mark=",")` AF (`r S77q.per`%)** to the Caloosahatchee through **S-77**, **`r ifelse(S308q<0,format(round(abs(S308q),0),big.mark=","),format(round(S308q,0),big.mark=","))` AF `r if(is.na(S308q.per)==F){paste0("(", S308q.per,"%)")}`** `r ifelse(S308q<0,"to Lake Okeechobee","to the St. Lucie River")` through **S-308**, **`r ifelse(S310q<0,format(round(abs(S310q),0),big.mark=","),format(round(S310q,0),big.mark=","))` AF `r if(is.na(S310q.per)==F){paste0("(", S310q.per,"%)")}`** through **S-310** in Clewiston, **`r ifelse(L8q<0,format(round(abs(L8q),0),big.mark=","),format(round(L8q,0),big.mark=","))` AF `r if(is.na(L8q.per)==F){paste0("(", L8q.per,"%)")}`** through **C-10A** `r ifelse(L8q<0,"to Lake Okeecobee","to the L-8 canal")`, and **`r ifelse(EAAq<0,format(round(abs(EAAq),0),big.mark=","),format(round(EAAq,0),big.mark=","))` AF `r if(is.na(EAAq.per)==F){paste0("(", EAAq.per,"%)")}`** `r ifelse(EAAq<0,"to Lake Okeechobee","to the EAA")` through **S-351, S-352, and S-354**.  -->

```{r}
S77.dat=readLines("https://w3.saj.usace.army.mil/h2o/reports/r-s77m.html")
S77.dat=data.frame(t(sapply(strsplit(S77.dat[11:17],"\\s+"),c)))
colnames(S77.dat)=c("Date","HW","TW","Q","Precip","WndDir","WndSp","Locks","Bar.Hg","Bar.mBar","Evap","Man.Prec")
S77.dat$Date=date.fun(S77.dat$Date,form="%d%B%y")
S77.dat[,2:12]=sapply(S77.dat[,2:12],as.numeric)
S77.dat$SITE="Moore Haven (S77)"
S77.dat$SITE2="S77"

S78.dat=readLines("https://w3.saj.usace.army.mil/h2o/reports/r-s78m.html")
S78.dat=data.frame(t(sapply(strsplit(S78.dat[11:17],"\\s+"),c)))
colnames(S78.dat)=c("Date","HW","TW","Q","Precip","WndDir","WndSp","Locks","Bar.Hg","Bar.mBar","Man.Prec")
S78.dat$Date=date.fun(S78.dat$Date,form="%d%B%y")
S78.dat[,2:11]=sapply(S78.dat[,2:11],as.numeric)
S78.dat$SITE="Ortona (S78)"
S78.dat$SITE2="S78"

S79.dat=readLines("https://w3.saj.usace.army.mil/h2o/reports/r-s79m.html")
S79.dat=data.frame(t(sapply(strsplit(S79.dat[11:17],"\\s+"),c)))
colnames(S79.dat)=c("Date","HW","TW","Q","Precip","WndDir","WndSp","Locks","Bar.Hg","Bar.mBar","Cl","Man.Prec")
S79.dat$Date=date.fun(S79.dat$Date,form="%d%B%y")
S79.dat[,2:12]=sapply(S79.dat[,2:12],as.numeric)
S79.dat$SITE="WP Franklin (S79)"
S79.dat$SITE2="S79"

vars=c("Date","SITE","Man.Prec")
RF.dat=rbind(S77.dat[,vars],S78.dat[,vars],S79.dat[,vars])

## 

Q.dat.xtab=q.dat.7day[,c("Date","S79","S78","S77")]
Q.dat.xtab[,2:4]=Q.dat.xtab[,2:4]*0.5041669
Q.dat.xtab=Q.dat.xtab[order(Q.dat.xtab$Date),]

## 
# vars=c("Date","SITE2","Q")
# Q.dat=rbind(S77.dat[,vars],S78.dat[,vars],S79.dat[,vars])
Q.dat=Q.dat.xtab[,c("Date","S79")]
Q.dat$Q=Q.dat$S79
# Q.dat.xtab=cast(Q.dat,Date~SITE2,value="Q",mean)[,c("Date","S79","S78","S77")]
Q7d.sum.tmp=round(apply(Q.dat.xtab[,2:4],2,mean))

Q.dat.xtab2=Q.dat.xtab
Q.dat.xtab2$Date=as.character(format(Q.dat.xtab2$Date,"%m/%d/%y"))
Q.dat.xtab2=rbind(Q.dat.xtab2,data.frame(Date="7-day avg",S79=mean(Q.dat.xtab$S79),S78=mean(Q.dat.xtab$S78),S77=mean(Q.dat.xtab$S77)))
Q.dat.xtab2[2:4]=round(Q.dat.xtab2[2:4],0)
# export Q.dat.xtab2 as excel - ACOE Daily Reports

dates2=c(date.fun(min(Q.dat.xtab$Date)-duration(365,'days')),date.fun(min(Q.dat.xtab$Date)-duration(1,'days')))
S79dat2=DBHYDRO_daily(dates2[1],dates2[2],"DJ237")
S79dat2$Q=S79dat2$Data.Value

S79dat2=rbind(S79dat2[,c("Date","Q")],Q.dat[,c("Date","Q")])
S79dat2$Q.14=with(S79dat2,roll_meanr(Q,n=14))
S79dat2$Q.7=with(S79dat2,roll_meanr(Q,n=7))

S79dat2$Low=with(S79dat2,ifelse(Q.14<750,1,0))
S79dat2$Opt=with(S79dat2,ifelse(Q.14>=750&Q.14<2100,1,0))
S79dat2$Stress=with(S79dat2,ifelse(Q.14>=2100&Q.14<2600,1,0))
S79dat2$Dam=with(S79dat2,ifelse(Q.14>=2600,1,0))
S79dat2$Date=date.fun(S79dat2$Date)

consec.startend=function(var){
  runs=rle(var)
  myruns = which(runs$values == TRUE)
  runs.lengths.cumsum = cumsum(runs$lengths)
  ends = runs.lengths.cumsum[myruns]
  newindex = ifelse(myruns>1, myruns-1, 0)
  starts = runs.lengths.cumsum[newindex] + 1
  if (0 %in% newindex) starts = c(1,starts)
  rslt=list(starts=starts,ends=ends)
  return(rslt)
}

S79dat2$Low.consec=0
for(i in 2:nrow(S79dat2)){
  S79dat2$Low.consec[i]=with(S79dat2,ifelse(Low[i-1]==0&Low[i]>0,1,
                                            ifelse(Low[i-1]>0&Low[i]>0,1,0)))
}
Low.consec.val=consec.startend(S79dat2$Low.consec)
S79dat2$sum.Low.consec=0
if(length(Low.consec.val$ends)!=0){
for(i in 1:length(Low.consec.val$ends)){
  S79dat2[Low.consec.val$ends[i],]$sum.Low.consec=with(S79dat2[c(Low.consec.val$starts[i]:Low.consec.val$ends[i]),],sum(Low.consec,na.rm=T))
}
}
#
S79dat2$Opt.consec=0
for(i in 2:nrow(S79dat2)){
  S79dat2$Opt.consec[i]=with(S79dat2,ifelse(Opt[i-1]==0&Opt[i]>0,1,
                                      ifelse(Opt[i-1]>0&Opt[i]>0,1,0)))
}
Opt.consec.val=consec.startend(S79dat2$Opt.consec)
#
S79dat2$sum.Opt.consec=0
if(length(Opt.consec.val$ends)!=0){
for(i in 1:length(Opt.consec.val$ends)){
  S79dat2[Opt.consec.val$ends[i],]$sum.Opt.consec=with(S79dat2[c(Opt.consec.val$starts[i]:Opt.consec.val$ends[i]),],sum(Opt.consec,na.rm=T))
}
}
# 
S79dat2$Stress.consec=0
for(i in 2:nrow(S79dat2)){
  S79dat2$Stress.consec[i]=with(S79dat2,ifelse(Stress[i-1]==0&Stress[i]>0,1,
                                            ifelse(Stress[i-1]>0&Stress[i]>0,1,0)))
}
Stress.consec.val=consec.startend(S79dat2$Stress.consec)
S79dat2$sum.Stress.consec=0
if(length(Stress.consec.val$ends)!=0){
for(i in 1:length(Stress.consec.val$ends)){
  S79dat2[Stress.consec.val$ends[i],]$sum.Stress.consec=with(S79dat2[c(Stress.consec.val$starts[i]:Stress.consec.val$ends[i]),],sum(Stress.consec,na.rm=T))
}
}
#
S79dat2$Dam.consec=0
for(i in 2:nrow(S79dat2)){
  S79dat2$Dam.consec[i]=with(S79dat2,ifelse(Dam[i-1]==0&Dam[i]>0,1,
                                               ifelse(Dam[i-1]>0&Dam[i]>0,1,0)))
}
Dam.consec.val=consec.startend(S79dat2$Dam.consec)
S79dat2$sum.Dam.consec=0
if(length(Dam.consec.val$ends)!=0){
for(i in 1:length(Dam.consec.val$ends)){
  S79dat2[Dam.consec.val$ends[i],]$sum.Dam.consec=with(S79dat2[c(Dam.consec.val$starts[i]:Dam.consec.val$ends[i]),],sum(Dam.consec,na.rm=T))
}
}
# S79dat2=subset(S79dat2,is.na(Q.14)==F)
salenv.vals=subset(S79dat2,Date==max(S79dat2$Date))

salenv.vals1=salenv.vals[,paste("sum",c("Low","Opt","Stress","Dam"),"consec",sep=".")]
colnames(salenv.vals1)=c("low","optimal","stress","damaging")
# as.numeric(salenv.vals1[which(salenv.vals1>0)])
# names(salenv.vals1)[which(salenv.vals1==max(salenv.vals1))]

flow.envs=c("< 750","750 - 2100", "2100 - 2600","> 2600")
cols=c("red","green","yellow","red")
```

**Caloosahatchee Conditions Summary:** Flow to the Caloosahatchee Estuary had a 7-day average of **`r format(Q7d.sum.tmp[1],big.mark=",")` cfs** at **S-79** with a 7-day average of **`r format(Q7d.sum.tmp[3],big.mark=",")` cfs (`r round((Q7d.sum.tmp[3]/Q7d.sum.tmp[1])*100)`%)** coming from the lake at **S-77**. **The 14-day moving average flow at S-79 is `r format(round(salenv.vals$Q.14),big.mark=",")` cfs and has been in the `r paste0("<span style='color:",cols[which(salenv.vals1==max(salenv.vals1))],"'>")` `r names(salenv.vals1)[which(salenv.vals1==max(salenv.vals1))]`</span> flow envelope (`r flow.envs[which(salenv.vals1==max(salenv.vals1))]` cfs; RECOVER 2020) for `r as.numeric(salenv.vals1[which(salenv.vals1==max(salenv.vals1))])` days.**

**Lake Flows:** In the past 7 days the total outflow from Lake Okeechobee was **`r format(round(q.from.Lake,0),big.mark=",")` AF** with **`r format(round(S77q,0),big.mark=",")` AF** to the Caloosahatchee through **S-77**,`r if(S308q.pos>0){paste("**",format(round(S308q.pos,0),big.mark=",")," AF** through **S-308** in Port Mayaca,",sep="")}` **`r format(round(S310q.pos,0),big.mark=",")` AF** through **S-310** in Clewiston, and **`r format(round(EAAq.pos,0),big.mark=",")` AF** to the EAA through **S-351**, **S-352**, and **S-354**. The total net inflow to the Lake was **`r format(round(q.in.Lake+q.BF.Lake,0),big.mark=",")` AF** (`r format(round(q.in.Lake,0),big.mark=",")` AF from Fisheating Creek, S-71, S-72, S-84s, S-65EX, and S-65EX1) `r if(q.BF.Lake>0){paste(" with a total backflow volume of ","**",format(round(q.BF.Lake,0),big.mark=",")," AF** from **", v.val,"**",sep="")}`. Water conservation areas received flows of **`r format(round(sum(totalQ[,c("WCA1")]),0),big.mark=",")` AF**, **`r format(round(sum(totalQ[,c("WCA2")]),0),big.mark=",")` AF**, and **`r format(round(sum(totalQ[,c("WCA3")]),0),big.mark=",")` AF** at **WCA1, WCA2, and WCA3**, respectively. Everglades National Park received **`r format(round(sum(totalQ[,c("ENP")]),0),big.mark=",")` AF**.

<br>
```{r,echo=F}
# Lake Inflow and Outflow based on map
  map.url=paste0("https://w3.saj.usace.army.mil/h2o/reports/StatusDaily/archive/",format(dates[13],"%m%d"),"/StatusDaily.htm")
  mapdata=readLines(map.url)
  
val=grep("Total Structure Outflow",mapdata)
# mapdata[val]
LakeIn=strsplit(mapdata[val],"\\s+")[[1]][4]
LakeOut=strsplit(mapdata[val],"\\s+")[[1]][9]

val=grep("../plots/ok8hhp.pdf",mapdata)
LakeStage=as.numeric(strsplit(mapdata[val[1]],"\\s+")[[1]][6])
```

<div class="row">
<div class="col-md-6">
**Lake Okeechobee Level: `r paste0(strsplit(LO.report[[1]][11],"\\s+")[[1]][5]," ft"," (",strsplit(LO.report[[1]][13],"  Currently in ")[[1]][2],")")`**

**Lake Okeechobee Inflow: `r paste(LakeIn,"cfs")# paste(strsplit(LO.report[[1]][45],"\\s+")[[1]][3],"cfs")`**

</div>

<div class="col-md-6">

**Last Week: `r paste(strsplit(LO.report[[1]][200],"\\s+")[[1]][9],"ft")`**

**Lake Okeechobee Outflow: `r paste(LakeOut,"cfs")# paste(strsplit(LO.report[[1]][52],"\\s+")[[1]][3],"cfs")`**
</div>
</div>



<!-- https://holtzy.github.io/Pimp-my-rmd/#several_columns -->
<div class="row">
<div class="col-md-3">
**Weekly Rainfall Total:** 
</div>
<div class="col-md-3">
WP Franklin **`r with(S79.dat,ifelse(sum(is.na(Man.Prec))!=0,paste("\u2265",format(sum(Man.Prec,na.rm=T),nsmall=2)),format(sum(Man.Prec,na.rm=T),nsmall=2)))`"**
</div>
<div class="col-md-3">
Ortona **`r with(S78.dat,ifelse(sum(is.na(Man.Prec))!=0,paste("\u2265",format(sum(Man.Prec,na.rm=T),nsmall=2)),format(sum(Man.Prec,na.rm=T),nsmall=2)))`"**
</div>
<div class="col-md-3">
Moore Haven **`r with(S77.dat,ifelse(sum(is.na(Man.Prec))!=0,paste("\u2265",format(sum(Man.Prec,na.rm=T),nsmall=2)),format(sum(Man.Prec,na.rm=T),nsmall=2)))`"**
</div>
</div>

```{r}
RF.dat%>%
  download_this(
    output_name = "RF7day",
    output_extension = ".xlsx",
    button_label = "Download Rainfall as .xlsx",
    button_type = "primary",
    has_icon = TRUE,
    icon = "fa fa-file-excel"
  )
```

```{r}
Q.dat.xtab2%>%
  download_this(
    output_name = "Discharge7day",
    output_extension = ".xlsx",
    button_label = "ACOE Daily Report ",
    button_type = "danger",
    has_icon = TRUE,
    icon = "fa fa-file-excel"
  )
```

```{r}
q.dat.7day2%>%
  download_this(
    output_name = "Discharge7day",
    output_extension = ".xlsx",
    button_label = "7-day Mean Discharge (cfs)",
    button_type = "danger",
    has_icon = TRUE,
    icon = "fa fa-file-excel"
  )
```

***

## Lake Okeechobee 

```{r dates,echo=FALSE,include=FALSE}
#Current WY
CurWY=as.numeric(ifelse(as.numeric(format(as.Date(Sys.time()),"%m"))>4,as.numeric(format(as.Date(Sys.time()),"%Y"))+1,format(as.Date(Sys.time()),"%Y")))
# CurWY

## Stage Data
TODAY=as.POSIXct(strptime(Sys.time(),"%F"),tz="EST") # -duration(1,"days")
YEST=date.fun(TODAY-duration(1,"days"))
End.Date=as.Date(Sys.time())+duration(1,"days")

Start.Date=as.Date(paste(CurWY-2,05,01,sep="-"))
Start.Date2=min(as.Date(Sys.time())-duration(35,"days"),as.Date(paste(CurWY-1,05,01,sep="-")))

STG.SDate=paste(format(Start.Date,"%Y"),format(Start.Date,"%m"),format(Start.Date,"%d"),sep="")
STG.EDate=paste(format(End.Date,"%Y"),format(End.Date,"%m"),format(End.Date,"%d"),sep="")

#For Plots
dates=c(Start.Date2,as.Date(Start.Date2+duration(366,"days")))
xlim.vals=as.POSIXct(strptime(dates,"%Y-%m-%d"),tz="EST")
xmaj=seq(xlim.vals[1],xlim.vals[2],by="2 months");xmin=seq(xlim.vals[1],xlim.vals[2],by="1 months")

lwd.val=1
```

<br>

### Stage Elevation

```{r LakeO Data, warnings=FALSE,echo=FALSE,include=FALSE}
#LORS
# load("LORS.RData")
LORS=read.csv("LORS.csv")
LORS$Year=CurWY-1
LORS$Date2=with(LORS,date.fun(paste(Year,Month,Day,sep="-")))

LORS2=LORS
LORS2$Year=CurWY
LORS2$Date2=with(LORS2,date.fun(paste(Year,Month,Day,sep="-")))

LORS.gaph2Yrs=rbind(LORS,LORS2)
rm(LORS,LORS2)
LORS.gaph2Yrs$Date2=date.fun(LORS.gaph2Yrs$Date2)

#Lake Okeechobee
comp.dbkey=data.frame(DBKEY=c("N3466","06832"),Priority=c("P2","P1"))

stg.da=data.frame()
for(i in 1:nrow(comp.dbkey)){
  tmp=DBHYDRO_daily(date.fun(paste(CurWY-4,"05-01",sep="-")),End.Date,comp.dbkey$DBKEY[i])
  tmp$DBKEY=as.character(comp.dbkey$DBKEY[i])
  stg.da=rbind(stg.da,tmp)
}
stg.da=merge(stg.da,comp.dbkey,"DBKEY")
stg.da$DATE=date.fun(stg.da$Date)

LakeO.xtab=cast(stg.da,DATE~Priority,value="Data.Value",mean)
LakeO.xtab$Mean=with(LakeO.xtab,ifelse(is.na(P1)==T,P2,P1))

tail(LakeO.xtab)

## USACE Stage data for the current year
# LO.url="https://w3.saj.usace.army.mil/h2o/reports/r-oke365.html"
# webpage=read_html(LO.url)
# node.val=html_nodes(webpage,"pre")
# 
# LO.text.vals=html_text(node.val)
# LO.report=strsplit(as.character(LO.text.vals),"\n")
# 
# Stg.day_CYR=data.frame(day=NA,Jan=NA,Feb=NA,Mar=NA,Apr=NA,May=NA,Jun=NA,Jul=NA,Aug=NA,Sep=NA,Oct=NA,Nov=NA,Dec=NA)
# stg.dat=gsub("\\s[|]\\s",",",LO.report[[1]][10:40])
# for(i in 1:31){
#  day.lne=strsplit(as.character(stg.dat[i]),",")
#  day.lne=unlist(day.lne)
#  day.lne2=unlist(lapply(day.lne,trimws))
# 
#  Stg.day_CYR=rbind(Stg.day_CYR,day.lne2)
# }
# Stg.day_CYR[2:13]=sapply(Stg.day_CYR[2:13],as.numeric)
# Stg.day_CYR
# Stg.day_CYR=melt(Stg.day_CYR)
# Stg.day_CYR$date=with(Stg.day_CYR,date.fun(paste(day,variable,format(Sys.Date(),'%Y'),sep="-"),form="%d-%B-%Y"))
# Stg.day_CYR=subset(Stg.day_CYR,is.na(date)==F)
# Stg.day_CYR=subset(Stg.day_CYR,is.na(value)==F)
# 
# tail(Stg.day_CYR)
# #
# Stg.day_CYR2=data.frame(DATE=Stg.day_CYR$date,P1=Stg.day_CYR$value,P2=NA,Mean=Stg.day_CYR$value)
# 
# if(max(subset(LakeO.xtab,is.na(P1)==F)$DATE)!=YEST){
#    LakeO.xtab=rbind(subset(LakeO.xtab,DATE<=max(subset(LakeO.xtab,is.na(P1)==F)$DATE)),
#                     subset(Stg.day_CYR2,DATE%in%seq(date.fun(max(subset(LakeO.xtab,is.na(P1)==F)$DATE)+ddays(1)),date.fun(YEST),"1 days")))
# }

# if(max(subset(LakeO.xtab,is.na(P1)==F)$DATE)!=YEST){
#    LakeO.xtab=rbind(subset(LakeO.xtab,DATE<=max(subset(LakeO.xtab,is.na(P1)==F)$DATE)),
#                     subset(Stg.day_CYR2,DATE%in%seq(date.fun(max(subset(LakeO.xtab,is.na(P1)==F)$DATE)+ddays(1)),date.fun(YEST),"1 days")))

Stg.day_CYR2=data.frame(DATE=map.stg$Date,P1=map.stg$Stg,P2=NA,Mean=map.stg$Stg)
if(max(subset(LakeO.xtab,is.na(P1)==F)$DATE)!=YEST){
  LakeO.xtab=rbind(subset(LakeO.xtab,DATE<=max(subset(LakeO.xtab,is.na(P1)==F)$DATE)),
                   subset(Stg.day_CYR2,DATE%in%seq(date.fun(max(subset(LakeO.xtab,is.na(P1)==F)$DATE)+ddays(1)),date.fun(YEST),"1 days")))
}


# if(max(LakeO.xtab$DATE)!=YEST|sum(is.na(subset(LakeO.xtab,DATE%in%seq(YEST-ddays(1),YEST,"1 days"))$Mean))==1){
#   da.dbks=data.frame(SITE=c("L001","L005","L006","LZ40","S133TW","S352HW","S4TW"),DBKEY=c("16022","12509","12519","16265","15826","FF579","15732"),type="Daily")
#   date1=if(max(LakeO.xtab$DATE)!=YEST){max(LakeO.xtab$DATE)}else{YEST}
#   tmp=DBHYDRO_daily(date1,YEST,da.dbks$DBKEY)
#   tmp$DATE=date.fun(tmp$Date)
#   tmp2=DBHYDRO_breakpoint(date1,YEST,"AI522")
#   tmp2$DATE=date.fun(tmp2$DATE)
#   tmp2.mean=ddply(tmp2,"DATE",summarise,Data.Value=round(mean(Data.Value,na.rm=T),2))
#   tmp2.mean$Station="S308HW"
# 
#   tmp.all=rbind(tmp[,c("DATE","Station","Data.Value")],tmp2.mean[,c("DATE","Station","Data.Value")])
#   calc.LakeO.stg=ddply(tmp.all,"DATE",summarise,Mean=round(mean(Data.Value,na.rm=T),2))
#   calc.LakeO.stg[,c("P1","P2")]=NA
#   LakeO.xtab=rbind(LakeO.xtab,calc.LakeO.stg[,names(LakeO.xtab)])
#   LakeO.xtab=LakeO.xtab[duplicated(LakeO.xtab$DATE,fromLast = T)==F,]
# }

LakeO.xtab=merge(x=LakeO.xtab,y=LORS.gaph2Yrs,by.x="DATE",by.y="Date2",all.x=T)

LakeO.xtab$Status=with(LakeO.xtab,ifelse(Mean>High,"within the High Lake",ifelse(Mean<High&Mean>Intermediate,"within the Operational High Sub-",ifelse(Mean<Intermediate&Mean>Low,"within the Operational Intermediate Sub-",ifelse(Mean<Low&Mean>BaseFlow,"within the Operational Low Sub-",ifelse(Mean<BaseFlow&Mean>BeneficialUse,"within the Operational Base Flow Sub-",ifelse(Mean<BeneficialUse&Mean>WSM,"within the Beneficial Use",ifelse(Mean<WSM,"within the Water Shortage Management",NA))))))))

LakeO.xtab$StatusLow=with(LakeO.xtab,ifelse(Mean<Low,"Below","Above"))
LakeO.xtab$DiffLow=with(LakeO.xtab,Mean-Low)

LakeO.xtab$recess_7day=with(LakeO.xtab,c(rep(NA,7),diff(Mean,lag=7)))
LakeO.xtab$recess_30day=with(LakeO.xtab,c(rep(NA,30),diff(Mean,lag=30)))

LakeO.xtab$WY=WY(LakeO.xtab$DATE)

LakeO.xtab$month=as.numeric(format(LakeO.xtab$DATE,"%m"))
LakeO.xtab$day=as.numeric(format(LakeO.xtab$DATE,"%d"))
LakeO.xtab$plot.dat=with(LakeO.xtab,date.fun(ifelse(month>4,paste(CurWY-1,month,day,sep="-"),paste(CurWY,month,day,sep="-"))))
LakeO.xtab$hydro.day=hydro.day(LakeO.xtab$DATE)

LakeO.xtab$DoY=as.numeric(format(LakeO.xtab$DATE,"%j"))
LakeO.xtab$CY=as.numeric(format(LakeO.xtab$DATE,"%Y"))
bks=c(min(LakeO.xtab$recess_7day,na.rm=T),-0.16,-0.05,0.05,0.25,max(LakeO.xtab$recess_7day,na.rm=T))
LakeO.xtab$cat=as.factor(findInterval(LakeO.xtab$recess_7day,bks,rightmost.closed = T,left.open = T))
date.fill=data.frame(expand.grid(CY=seq(min(LakeO.xtab$CY),max(LakeO.xtab$CY),1),
            DoY=1:366))

LakeO.xtab.rec=LakeO.xtab[,c("CY","DoY","WY","recess_7day","cat")]
LakeO.xtab.rec=merge(LakeO.xtab.rec,date.fill,by=c("CY",'DoY'),all.y=T)

cols=c("1"="red","2"="yellow","3"="green","4"="goldenrod2","5"="darkred")
cols=c("red","yellow","green","goldenrod2","darkred")
LakeO.xtab.rec$cols=cols[LakeO.xtab.rec$cat]
LakeO.xtab.rec$cols[is.na(LakeO.xtab.rec$cols)==T]="white"
LakeO.xtab.rec2=subset(LakeO.xtab.rec,WY%in%seq(CurWY-3,CurWY,1))


```

```{r LORSplot,echo=FALSE,fig.width=7,fig.height=5,fig.align='center'}
HighLakeLab.x=as.POSIXct(paste(CurWY-1,9,1,sep="-"))
WSMLab.x=as.POSIXct(paste(CurWY-1,9,1,sep="-"))
BENLab.x=as.POSIXct(paste(CurWY-1,7,15,sep="-"))
BASELab.x=as.POSIXct(paste(CurWY,4,1,sep="-"))
HIGHLab.x=as.POSIXct(paste(CurWY,3,15,sep="-"))
InterLab.x=as.POSIXct(paste(CurWY,3,1,sep="-"))
LowLab.x=as.POSIXct(paste(CurWY,2,15,sep="-"))

lwd.val=1
xlim.vals=as.POSIXct(strptime(c(as.Date(paste(CurWY-1,05,01,sep="-")),as.Date(paste(CurWY,05,01,sep="-"))),"%Y-%m-%d"),tz="EST")#as.POSIXct(strptime(dates,"%Y-%m-%d"),tz="EST")
xmaj=seq(xlim.vals[1],xlim.vals[2],by="2 months");xmin=seq(xlim.vals[1],xlim.vals[2],by="1 months")
ylim.val=c(9,18);by.y=1
ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)

par(family="serif",mar=c(0.5,2,1,1),oma=c(0.5,3,1,1));
  layout(matrix(1:2,2,1,byrow=T),heights=c(1,0.25))
plot(High~Date2,LORS.gaph2Yrs,ylim=ylim.val,xlim=xlim.vals,type="n",lwd=2,ylab=NA,xlab=NA,yaxs="i",xaxs="i",xaxt="n",yaxt="n")
abline(h=seq(9,18,1),lwd=1,col="grey",lty=3)
abline(v=seq(xlim.vals[1],xlim.vals[2],by="1 months"),lwd=1,col="grey",lty=3)
with(LORS.gaph2Yrs,lines(High~Date2,lwd=2,col="black"))
with(LORS.gaph2Yrs,lines(Intermediate~Date2,lwd=2,col="black"))
with(LORS.gaph2Yrs,lines(Low~Date2,lwd=2,col="black"))
with(LORS.gaph2Yrs,lines(BaseFlow~Date2,lwd=2,col="black"))
with(LORS.gaph2Yrs,lines(BeneficialUse~Date2,lwd=2,col="black"))
with(LORS.gaph2Yrs,lines(WSM~Date2,lwd=2,col="grey"))
with(LORS.gaph2Yrs,lines(Inter1ft~Date2,lwd=2,lty=5,col="black"))
with(LORS.gaph2Yrs,lines(LowLow~Date2,lwd=2,lty=5,col="grey"))
with(LORS.gaph2Yrs,lines(LowMid~Date2,lwd=2,lty=5,col="grey"))
text(HighLakeLab.x,17.5,"High Lake Management Band",font=2)
text(WSMLab.x,9.5,"Water Shortage Management Band",font=2)
text(BENLab.x,12,"Beneficial Use",font=2)
text(BASELab.x,13,"Base Flow",font=2)
text(HIGHLab.x,17,"High",font=2)
text(InterLab.x,16.25,"Intermediate ",font=2,cex=0.75)
text(LowLab.x,14.5,"Low",font=2,cex=0.75)
with(subset(LakeO.xtab,WY==CurWY-2),lines(plot.dat,Mean,lwd=4,col=adjustcolor("forestgreen",0.5),lty=1))
with(subset(LakeO.xtab,WY==CurWY-1),lines(plot.dat,Mean,lwd=4,col=adjustcolor("blue",0.5),lty=1))
with(LakeO.xtab,lines(DATE,Mean,lwd=4,col="red",lty=1))
if(is.na(subset(LakeO.xtab,DATE==YEST)$Mean)==T|nrow(subset(LakeO.xtab,DATE==YEST))==0){NA}else{
with(subset(LakeO.xtab,DATE==YEST),points(DATE,Mean,pch=21,bg=adjustcolor("red",0.5),col="red",lwd=0.1,cex=1.25))
with(subset(LakeO.xtab,DATE==YEST),segments(DATE,Mean,DATE,10.1,lty=2))
with(subset(LakeO.xtab,DATE==YEST),text(DATE,10,paste(format(round(Mean,2),nsmall=2),"Ft"),cex=0.8,xpd=NA))}

axis_fun(1,xmaj,xmin,format(xmaj,"%b"),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj)
box(lwd=lwd.val)
mtext(side=1,"Month",line=2,cex=1.25)
mtext(side=2,"Stage Elevation (Feet, NGVD29)",line=2.5,cex=1.25)
mtext(side=3,adj=0,paste("Date:",format(date.fun(Sys.Date()-ddays(1)),"%b %d, %Y")))
mtext(side=3,adj=1,"Data are provisional and subject to change",col="red")

plot(0:1,0:1,type = 'n', axes = F,xlab=NA, ylab=NA)
legend(0.5,0.5,
       legend=c(paste0("WY",CurWY),paste0("WY",CurWY-1),paste0("WY",CurWY-2)),
       col=c("red",adjustcolor(c("blue","forestgreen"),0.5)),lty=c(1,1),lwd=c(4,4,4),ncol=3,cex=1,bty="n",y.intersp=1,x.intersp=0.5,xpd=NA,xjust=0.5)
```

<font size=2><center>Lake Okeechobee daily average stage elevation for water year `r CurWY` (`r paste0("WY",CurWY)`)  relative to the last two water years (<font color="red">red</font> line) relative to the Lake Okeechobee Regulation Schedule (LORS) .</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

<br>

```{r}
cap.val="Stage and recession rates this time for the current and last three water years"

subset(LakeO.xtab,hydro.day==hydro.day(YEST))%>%
  flextable(col_keys=c("DATE","WY","Mean","recess_7day","recess_30day"))%>%
  width(width=c(1,1,1.25,1.5,1.5))%>%
  align(align="center",part="all")%>%
  colformat_datetime(j=1,fmt_date="%m-%d")%>%
  colformat_double(j=2,big.mark="",digits=0)%>%
  colformat_num(j=3:5,na_str="- NR -")%>%
  padding(padding=1,part="all")%>%
  font(fontname="Times New Roman",part="all")%>%
  fontsize(size=12,part="body")%>%
  fontsize(size=13,part="header")%>%
  bold(part="header")%>%
  set_header_labels("DATE"="Date\n(Month-Day)",
                    "WY"="Water Year",
                    "Mean"="Stage\n(ft, NGVD29)",
                    "recess_7day"="7-Day Recession Rate\n(ft 7-d\u207B\u00B9)",
                    "recess_30day"="30-Day Recession Rate\n(ft 30-d\u207B\u00B9)")%>%
  bg(i=~WY==CurWY,part="body",bg="wheat")%>%
  footnote(i=4,j=3,value=ifelse(is.na(subset(LakeO.xtab,DATE==YEST)$P1)==T|is.na(subset(LakeO.xtab,DATE==YEST)$P2)==T,as_paragraph("Value estimated from average stage height across L001, L005, L006, LZ40, S133TW, S352HW & S4TW"),as_paragraph("Value provided by SFWMD DBKEY:N3466")),ref_symbols =c(" A "))%>%
  add_header_lines(values=cap.val)%>%align(align="center",part="header")%>%fontsize(size=13,part="header")%>%
  footnote(j=5,part="header",value=as_paragraph("-0.5 ft 30-d\u207B\u00B9 maximum 30-day Recession Rate for HAB Deviation"),ref_symbols =c(" B "))
    

```

*  As of `r if(is.na(subset(LakeO.xtab, DATE==YEST)$Mean)==T){format(YEST-ddays(1),"%m/%d/%Y")}else{format(YEST,"%m/%d/%Y")}` the mean stage elevation in Lake Okeechobee is `r if(is.na(subset(LakeO.xtab, DATE==YEST)$Mean)==T){subset(LakeO.xtab,DATE==YEST-ddays(1))$Status}else{subset(LakeO.xtab,DATE==YEST)$Status} ` Management Band at a stage elevation  of `r if(is.na(subset(LakeO.xtab, DATE==YEST)$Mean)==T){round(subset(LakeO.xtab,DATE==YEST-ddays(1))$Mean,2)}else{round(subset(LakeO.xtab,DATE==YEST)$Mean,2)}` feet (NGVD29).



```{r LOK_recess1,echo=FALSE,fig.width=7,fig.height=5,fig.align='center'}
lwd.val=1
ylim.val=c(-2,2);by.y=1
ymaj=c(0,seq(ylim.val[1],ylim.val[2],by.y));ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.vals=as.POSIXct(strptime(c(as.Date(paste(CurWY-1,05,01,sep="-")),as.Date(paste(CurWY,05,01,sep="-"))),"%Y-%m-%d"),tz="EST")
#xlim.vals=as.POSIXct(strptime(dates,"%Y-%m-%d"),tz="EST")
xmaj=seq(xlim.vals[1],xlim.vals[2],by="2 months");xmin=seq(xlim.vals[1],xlim.vals[2],by="1 months")

#LakeO.xtab$recess_7day=with(LakeO.xtab,ifelse(is.na(recess_7day)==T,0,recess_7day))
#LakeO.xtab$recess_30day=with(LakeO.xtab,ifelse(is.na(recess_30day)==T,0,recess_30day))

par(family="serif",cex.axis=1,mar=c(2,2,1,1),oma=c(2,3,1,1));
# layout(matrix(1:2,2,1),heights=c(1,0.25))
plot(recess_30day~DATE,LakeO.xtab,ylim=ylim.val,xlim=xlim.vals,type="n",lwd=2,ylab=NA,xlab=NA,yaxs="i",xaxs="i",xaxt="n",yaxt="n")
abline(v=xmin,h=ymin,lwd=1,col="grey",lty=3)
abline(h=0);
#with(LakeO.xtab,lines(DATE,recess_7day,lwd=1.5,col="black",lty=1))
# with(LakeO.xtab,shaded.range(DATE,rep(0,length(DATE)),recess_30day,"dodgerblue1",lty=1))
with(LakeO.xtab,lines(DATE,recess_30day,col="dodgerblue1",lty=1,lwd=1.5))
# with(subset(LakeO.xtab,WY==2019),lines(plot.dat,recess_30day,col="grey",lty=1,lwd=2))
with(LakeO.xtab,lines(DATE,recess_7day,col="indianred1",lty=2,lwd=1.5))
points(YEST,subset(LakeO.xtab,DATE==YEST)$recess_30day,pch=21,bg="dodgerblue1",cex=1.25)
text.x=if(YEST>date.fun(paste0(CurWY,"-04-01"))){YEST-ddays(15)}else{YEST+ddays(15)}
# if(subset(LakeO.xtab,DATE==YEST)$recess_30day!=0){text(text.x,subset(LakeO.xtab,DATE==YEST)$recess_30day,round(subset(LakeO.xtab,DATE==YEST)$recess_30day,2),cex=0.8)}
text(text.x,subset(LakeO.xtab,DATE==YEST)$recess_30day,round(subset(LakeO.xtab,DATE==YEST)$recess_30day,2),cex=0.8)
points(YEST,subset(LakeO.xtab,DATE==YEST)$recess_7day,pch=21,bg="indianred1",cex=1.25)
text.x=if(YEST>date.fun(paste0(CurWY,"-04-01"))){YEST-ddays(15)}else{YEST+ddays(15)}
# if(subset(LakeO.xtab,DATE==YEST)$recess_7day!=0){text(text.x,subset(LakeO.xtab,DATE==YEST)$recess_7day,round(subset(LakeO.xtab,DATE==YEST)$recess_7day,2),cex=0.8)}
text(text.x,subset(LakeO.xtab,DATE==YEST)$recess_7day,round(subset(LakeO.xtab,DATE==YEST)$recess_7day,2),cex=0.8)
# abline(h=-0.5,lty=2,col="black",lwd=2); #max 30d recession - HAB deviation
axis_fun(1,xmaj,xmin,format(xmaj,"%b"),cex.axis=1)
axis_fun(2,ymaj,ymin,format(ymaj),cex.axis=1)
box(lwd=lwd.val)
mtext(side=1,"Month",line=2.25,cex=1.5)
mtext(side=2,"Recession/Ascension Rate",line=2.5,cex=1.5)

# plot(0:1,0:1,type = 'n', axes = F,xlab=NA, ylab=NA)
# legend("topright",
#        legend=c("Moving 7-day (Ft 7-days\u207B\u00B9)","Moving 30-day (Ft 30-days\u207B\u00B9)","Max 30-day Recession Rate\nHAB Deviation"),
#        col=c("indianred1","dodgerblue1","black"),lty=c(2,1,2),lwd=c(1.5),ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=0.5,xpd=NA,xjust=0.5)
legend("topright",
       legend=c("Moving 7-day (Ft 7-days\u207B\u00B9)","Moving 30-day (Ft 30-days\u207B\u00B9)"),
       col=c("indianred1","dodgerblue1"),lty=c(2,1),lwd=c(1.5),ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=0.5,xpd=NA,xjust=0.5)
```

<font size=2><center>Lake Okeechobee 7-day and 30-day water level recession/ascension rates during `r paste0("WY",CurWY)`. Negative values indicate falling water levels (recession) and positive values indicate raising water level (ascension) during this 7-day period .</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>


```{r LOK_recess2,echo=FALSE,fig.width=8,fig.height=3.75,fig.align='center'}
ylim.val=c(CurWY-3,CurWY-1);by.y=1;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/by.y)
ylim.val2=ylim.val
ylim.val=c(ylim.val[1]-0.5,ylim.val[2]+0.5)
xlim.val=c(1,366);by.x=60;xmaj=c(1,60,120,180,240,300,360);xmin=seq(0,xlim.val[2],by.x/2)#seq(xlim.val[1],xlim.val[2],by.x);xmin=seq(xlim.val[1],xlim.val[2],by.x/2)
xlim.val=c(1-0.5,xlim.val[2]+0.5)

par(family="serif",mar=c(2,1,1,1),oma=c(1,3,2,1));
  layout(matrix(1:2,1,2,byrow=T),widths=c(1,0.3))

plot(CY~DoY,LakeO.xtab.rec,xlim=xlim.val,ylim=rev(ylim.val),type="n",xaxs="i",yaxs="i",axes=F,ann=F)
for(i in seq(ylim.val2[1],ylim.val2[2],1)){
tmp=subset(LakeO.xtab.rec,CY==i)
rect(seq(0.5,365.5,1),i+0.5,366.5,i-0.5,col=tmp$cols,border=adjustcolor("grey",0.3),lwd=0.1)
}
axis_fun(1,xmaj,xmin,xmaj,line=-0.5)
axis_fun(2,rev(ymaj),ymin,rev(ymaj))
box(lwd=1)
mtext(side=1,line=1.75,"Day of Year")
mtext(side=2,line=3,"Year")
mtext(side=3,adj=0,line=1.25,"Lake Okeechobee Recession/Accession Rate")
mtext(side=3,adj=0,"Observed Weekly Recession/Accession Rates",cex=0.75,col="grey50")

par(mar=c(2,0.5,1,0.5))
plot(0:1,0:1,ann=F,axes=F,type="n")
pal=cols
labs=c("\u2264 -0.16","> -0.16 & < -0.05","> -0.05 & \u2264 0.05","> 0.05 & \u2264 0.25","> 0.25")
n.bks=length(labs)
top.val=0.65
bot.val=0.35
x.max=0.20
x.min=0.10
bx.val= seq(bot.val,top.val,(top.val-bot.val)/n.bks)
rect(x.min,bx.val[1:n.bks],x.max,bx.val[2:(n.bks+1)],col=rev(pal),lty=0)
text(x=x.max, y = bx.val[2:(n.bks+1)]-c(mean(diff(bx.val[2:(n.bks+1)]))/2), labels = rev(labs),cex=0.75,adj=0,pos=4)
text(x=x.min+((x.max-x.min)/2),y=top.val,"Weekly Recession\nRate (ft/wk)",adj=0,cex=0.75,pos=3,xpd=NA)


```

<font size=2><center>Lake Okeechobee 7-day water level recession/ascension rates stop-light metric relative to the draft Snail Kite Performance Measure.</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

***

### Regional Rainfall

```{r,echo=F,warning=F}
## From USACE pages
S77.dat=readLines("https://w3.saj.usace.army.mil/h2o/reports/r-s77m.html")
S77.dat=data.frame(t(sapply(strsplit(S77.dat[11:17],"\\s+"),c)))
colnames(S77.dat)=c("Date","HW","TW","Q","Precip","WndDir","WndSp","Locks","Bar.Hg","Bar.mBar","Evap","Man.Prec")
S77.dat$Date=date.fun(S77.dat$Date,form="%d%B%y")
S77.dat[,2:12]=sapply(S77.dat[,2:12],as.numeric)
S77.dat$SITE="S77 (Moore Haven)"

S78.dat=readLines("https://w3.saj.usace.army.mil/h2o/reports/r-s78m.html")
S78.dat=data.frame(t(sapply(strsplit(S78.dat[11:17],"\\s+"),c)))
colnames(S78.dat)=c("Date","HW","TW","Q","Precip","WndDir","WndSp","Locks","Bar.Hg","Bar.mBar","Man.Prec")
S78.dat$Date=date.fun(S78.dat$Date,form="%d%B%y")
S78.dat[,2:11]=sapply(S78.dat[,2:11],as.numeric)
S78.dat$SITE="S78 (Ortona)"

S79.dat=readLines("https://w3.saj.usace.army.mil/h2o/reports/r-s79m.html")
S79.dat=data.frame(t(sapply(strsplit(S79.dat[11:17],"\\s+"),c)))
colnames(S79.dat)=c("Date","HW","TW","Q","Precip","WndDir","WndSp","Locks","Bar.Hg","Bar.mBar","Cl","Man.Prec")
S79.dat$Date=date.fun(S79.dat$Date,form="%d%B%y")
S79.dat[,2:12]=sapply(S79.dat[,2:12],as.numeric)
S79.dat$SITE="S79 (WP Franklin)"

vars=c("Date","SITE","Man.Prec")
RF.dat.USACE=rbind(S77.dat[,vars],S78.dat[,vars],S79.dat[,vars])
colnames(RF.dat.USACE)<-c("Date","SITE","Data.Value")


rf.dbkey=data.frame(DBKEY=c("16414","15495","16415"),SITE=c("S79 (WP Franklin)","S78 (Ortona)","S77 (Moore Haven)"))

rf.dat=data.frame()
for(i in 1:nrow(rf.dbkey)){
tmp=DBHYDRO_daily(Start.Date,YEST,rf.dbkey$DBKEY[i])  
tmp$DBKEY=as.character(rf.dbkey$DBKEY[i])
rf.dat=rbind(rf.dat,tmp)
}

rf.dat$Data.Value[rf.dat$Data.Value<0]<-0
rf.dat=merge(rf.dat,rf.dbkey,"DBKEY")
rf.dat$Date=date.fun(rf.dat$Date)

rf.dat=rbind(rf.dat[,c("SITE","Date","Data.Value")],RF.dat.USACE)
rf.dat=subset(rf.dat,is.na(Data.Value)==F)
rf.dat=ddply(rf.dat,c('Date',"SITE"),summarise,Data.Value=max(Data.Value,na.rm=T))

rf.dat$WY=WY(rf.dat$Date)
rf.dat$hydro.DOY=hydro.day(rf.dat$Date)
rf.dat=rf.dat[order(rf.dat$SITE,rf.dat$Date),]
rf.dat$cumRF=with(rf.dat,ave(Data.Value,paste(SITE,WY),FUN=function(x) cumsum(x)))

rf.dat.da=ddply(subset(rf.dat,Date%in%seq(date.fun(YEST-ddays(6)),date.fun(YEST),"1 days")),c("SITE"),summarise,TRF=sum(Data.Value,na.rm=T))
rf.dat.da=rf.dat.da[match(rf.dat.da$SITE,rf.dbkey$SITE),]

cap.val=paste0("Weekly (",format(date.fun(YEST-ddays(6)),"%m/%d")," - ", format(YEST,"%m/%d"),") rainfall totals along the Caloosahatchee River")

rf.dat.da%>%
  flextable()%>%
  align(j=2,align="center",part="all")%>%
  colformat_double(j=2,big.mark="",digits=1)%>%
  padding(padding=2,part="all")%>%
  font(fontname="Times New Roman",part="all")%>%
  fontsize(size=12,part="body")%>%
  fontsize(size=13,part="header")%>%
  bold(part="header")%>%
  set_header_labels("SITE"="Mointoring Location",
                    "TRF"="Weekly\nRainfall\nTotal\n(inches)")%>%
  width(width=c(1.5,1.5))%>%
  footnote(j=1,part="header",value=as_paragraph("Data Source: SFWMD DBHYDRO (DBKEYS 16414,15495,16415) and USACE reports"),ref_symbols=c(" 1 "))%>%
  footnote(j=2,part="header",value=as_paragraph(paste("Based on data from ",format(date.fun(YEST-ddays(6)),"%m/%d/%Y")," - ",format(YEST,"%m/%d/%Y"))),ref_symbols =c(" 2 "))%>%
  add_header_lines(values=cap.val)%>%align(align="center",part="header")%>%fontsize(size=13,part="header")

```


```{r CRE_RF,echo=FALSE,warning=F,fig.width=6.5,fig.height=4,fig.align='center'}

xlim.val=date.fun(c(paste(CurWY-1,05,01,sep="-"),paste(CurWY,05,01,sep="-")));by.x=90;by.x.min=30;
xmaj=seq(xlim.val[1],xlim.val[2],by=paste(by.x,"days"));
xmin=seq(xlim.val[1],xlim.val[2],paste(by.x.min,"days"))

xlim.val2=c(0,366);
xmaj2=seq(xlim.val2[1],xlim.val2[2],by.x);
xmin2=seq(xlim.val2[1],xlim.val2[2],by.x.min)

ylim.max=max(subset(rf.dat,Date%in%seq(xlim.val[1],xlim.val[2],"1 days"))$Data.Value,na.rm=T)
# if(ylim.max==0){ylim.max=max(subset(rf.dat,WY==CurWY-1)$Data.Value,na.rm=T)}
ylim.val=c(0,ceiling(ylim.max+ylim.max*0.2));by.y=max(ylim.val)/2;
ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)

par(family="serif",cex.axis=1,mar=c(1,1,1,1),oma=c(2.5,4,1,1));
layout(matrix(1:6,2,3,byrow=T),heights=c(0.5,1))
for(i in 1:3){
plot(Data.Value~Date,rf.dat,ylim=rev(ylim.val),xlim=xlim.val,ann=F,axes=F,type="n",yaxs="i")
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(subset(rf.dat,SITE==rf.dbkey$SITE[i]),segments(Date,0,Date,Data.Value,col="dodgerblue1",lwd=2))
# with(subset(rf.dat,SITE==rf.dbkey$SITE[i]),points(Date,Data.Value,pch=19,col="dodgerblue1",lwd=0.01))
# axis_fun(1,xmaj,xmin,format(xmaj,"%m-%Y"))
axis_fun(1,xmaj,xmin,NA)
if(i==1){axis_fun(2,ymaj,ymin,format(ymaj))}else(axis_fun(2,ymaj,ymin,NA))
box(lwd=1)
mtext(side=3,rf.dbkey$SITE[i])
if(i==1){mtext(side=2,line=2,"Daily Rainfall\n(inches)")}
}


ylim.max=max(subset(rf.dat,SITE%in%rf.dbkey$SITE)$cumRF,na.rm=T)
ylim.val=c(0,ceiling(ylim.max+ylim.max*0.1));by.y=20;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
for(i in 1:3){
plot(Data.Value~hydro.DOY,rf.dat,ylim=ylim.val,xlim=xlim.val2,ann=F,axes=F,type="n",yaxs="i")
abline(h=ymaj,v=xmaj2,lty=3,col="grey")
with(subset(rf.dat,SITE==rf.dbkey$SITE[i]&WY==CurWY),lines(hydro.DOY,cumRF,lwd=2,col="dodgerblue1"))
with(subset(rf.dat,SITE==rf.dbkey$SITE[i]&WY==CurWY-1),lines(hydro.DOY,cumRF,lwd=1,col=adjustcolor("indianred1",0.5)))
if(i==1){
  legend("topleft",legend=c(paste0("WY",CurWY-1),paste0("WY",CurWY)),
         lwd=c(1,2),col=c(adjustcolor("indianred1",0.5),"dodgerblue1"),pch=NA,
         ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.5,xpd=NA,xjust=0.5)
}
axis_fun(1,xmaj2,xmin2,format(xmaj,"%m-%y"),line=-0.5)
if(i==1){axis_fun(2,ymaj,ymin,ymaj)}else{axis_fun(2,ymaj,ymin,NA)}
box(lwd=1)
if(i==1){mtext(side=2,line=2,"Cumulative Rainfall (inches)")}
if(i==2){mtext(side=1,line=2.5,"Date (Month-Year)")}
}


```

***
### Relative Algae Condition

```{r LOKsonde_data, warnings=FALSE,echo=FALSE,include=FALSE}
dates=c(Start.Date,End.Date)
sites.dat=data.frame(Station.ID=c(rep("L001",5),rep("POLESOUT1",5),rep("POLESOUT3",5),rep("L005",5),rep("LZ40",5),rep("L006",5)),
                     param=rep(c("CF","CU","PF","PU","TURB"),6),
                     DBKEY.da=c(39923,39924,39925,39926,39922,
                                39959,39960,39961,39962,39958,
                                39975,39976,39977,39981,39974,
                                39886,39888,39889,39890,39885,
                                39941,39942,39943,39944,39940,
                                39905,39906,39907,39908,39904),depth="surface")
sonde.dat=data.frame()
for(i in 1:length(unique(sites.dat$Station.ID))){
  site.tmp=subset(sites.dat,Station.ID==unique(sites.dat$Station.ID)[i])
  site.tmp$DBKEY.da=as.character(site.tmp$DBKEY.da)
  tmp.dat=DBHYDRO_daily(dates[1],dates[2],site.tmp$DBKEY.da)
  tmp.dat$DBKEY=as.character(tmp.dat$DBKEY)
  tmp.dat=merge(tmp.dat,site.tmp,by.x="DBKEY",by.y="DBKEY.da")
  sonde.dat=rbind(sonde.dat,tmp.dat)  
  print(i)
}

sonde.dat$Data.Value=with(sonde.dat,ifelse(Data.Value<0,NA,Data.Value))
sonde.dat.xtab=cast(sonde.dat,Station.ID+Date~param,value="Data.Value",mean)
sonde.dat.xtab$Date=date.fun(sonde.dat.xtab$Date)
sonde.dat.xtab$Date.num=as.numeric(sonde.dat.xtab$Date)
sonde.dat.xtab$phy_chl=with(sonde.dat.xtab,PU/(PU+CU))

```

```{r, out.width="30%",echo=FALSE,fig.align="center"}
knitr::include_graphics("LakeO_sonde_map.png")
```

<font size=3><center> Sonde monitoring locations within Lake Okeechobee conducted by SFWMD.</center></font>

<br>

```{r LOKsonde,echo=FALSE,warning=F,fig.width=8,fig.height=5,fig.align='center'}
EDate.plot=as.Date(Sys.time())+duration(5,"days")
SDate.plot=as.Date(EDate.plot-duration(14,"days"))
xlim.val=as.POSIXct(strptime(c(SDate.plot,EDate.plot),"%Y-%m-%d"),tz="EST")
xmaj=seq(xlim.val[1],xlim.val[2],by="7 days");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")

par(family="serif",mar=c(1,1.5,0.25,0.25),oma=c(2.5,5.5,1,0.5));
layout(matrix(c(1:24),4,6,byrow=F))

max.turb=ceiling(max(sonde.dat.xtab$TURB,na.rm=T)+max(sonde.dat.xtab$TURB,na.rm=T)*0.2)

site.list=unique(sites.dat$Station.ID)
for(i in 1:length(site.list)){
tmp.dat=subset(sonde.dat.xtab,Station.ID==site.list[i])
axisln.val=3

max.Chla=max(sonde.dat.xtab$CU,na.rm=T)
ylim.max=if(max.Chla>100){round(max.Chla+max.Chla*0.25,-2)}else{100}
ylim.val=c(1,ylim.max);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")#;by.y=50#ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(CF~Date,tmp.dat,ylim=ylim.val,xlim=xlim.val,type="n",axes=F,ylab=NA,xlab=NA,log="y")
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(tmp.dat,pt_line(Date,CU,2,"mediumspringgreen",1,21,"mediumspringgreen",pt.lwd=0.1,cex=1.25))
abline(h=c(20,40),col="red",lty=2)
axis_fun(1,xmaj,xmin,NA)
if(i==1){axis_fun(2,ymaj,ymin,ymaj)}else{axis_fun(2,ymaj,ymin,NA)}
box(lwd=1)
if(i==1){mtext(side=2,line=axisln.val,"Chlorophyll\n(\u03BCg L\u207B\u00B9)")}
mtext(side=3,adj=0,site.list[i],cex=0.75)

ylim.val=c(1,1500);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")#;by.y=500;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(PF~Date,tmp.dat,ylim=ylim.val,xlim=xlim.val,type="n",axes=F,ylab=NA,xlab=NA,log="y")
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(tmp.dat,pt_line(Date,PU,2,"lightseagreen",1,21,"lightseagreen",pt.lwd=0.1,cex=1.25))
axis_fun(1,xmaj,xmin,NA)
abline(h=c(40),lty=2,col="red")
if(i==1){axis_fun(2,ymaj,ymin,ymaj)}else{axis_fun(2,ymaj,ymin,NA)}
box(lwd=1)
if(i==1){mtext(side=2,line=axisln.val,"Phycocyanin\n(\u03BCg L\u207B\u00B9)")}

ylim.val=c(0,1.1);by.y=0.5;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(phy_chl~Date,tmp.dat,ylim=ylim.val,xlim=xlim.val,type="n",axes=F,ylab=NA,xlab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(tmp.dat,pt_line(Date,phy_chl,2,"grey",1,21,"grey",pt.lwd=0.1,cex=1.25))
# if(sum(is.na(tmp.dat$phy_chl))/nrow(tmp.dat)==1){NA}else{
#   tmp.loess=loess(phy_chl~Date.num,tmp.dat)
#   fit=predict(tmp.loess,tmp.dat)
#   lines(tmp.dat$Date,fit,col="indianred1",lwd=2)}
# axis_fun(1,xmaj,xmin,NA)
if(i==1){axis_fun(2,ymaj,ymin,format(ymaj))}else{axis_fun(2,ymaj,ymin,NA)}
box(lwd=1)
if(i==1){mtext(side=2,line=axisln.val,expression(paste(frac("Phyco","Phyco + Chl"))),adj=0.5)}

max.Turb=max(sonde.dat.xtab$TURB,na.rm=T)
ylim.max=if(max.Turb>1000){round(max.Turb+max.Turb*0.25,-2)}else{1000}
ylim.val=c(1,ylim.max);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
# ylim.val=c(0,1000);by.y=500;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(TURB~Date,tmp.dat,ylim=ylim.val,xlim=xlim.val,type="n",axes=F,ylab=NA,xlab=NA,log="y")
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(tmp.dat,pt_line(Date,TURB,2,"grey",1,21,"lightgoldenrod2",pt.lwd=0.1,cex=1.25))
# tmp.loess=loess(TURB~Date.num,tmp.dat)
# fit=predict(tmp.loess,tmp.dat)
# lines(tmp.dat$Date,fit,col="indianred1",lwd=2)
axis_fun(1,xmaj,xmin,format(xmaj,"%m-%d"),line=-0.5)
if(i==1){axis_fun(2,ymaj,ymin,ymaj)}else{axis_fun(2,ymaj,ymin,NA)}
box(lwd=1)
if(i==1){mtext(side=2,line=axisln.val,"Turbidity\n(NTU)")}
}
mtext(side=1,outer=T,line=1,"Date (Month-Day)")

```

<font size=2><center> Daily Chlorophyll, Phycocyanin,relative ratio of Phycocyanin (Phyco) relative to Phyco and Chlorophyll (Chl) and Turbidity within Lake Okeechobee monitored by SFWMD. Chlorophyll and Phycocyanin are plotted on log-scale. Thresholds of concern/risk identified for Chlorophyll (20 and 40 &mu;g/L) and Phycocyanin (40 &mu;g/L; Cotterill et al 2019 & Macrio et al 2015).</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

<ul>
<li>Cotterill et al (2019) Phycocyanin sensors as an early warning system for cyanobacteria blooms concentrations: a case study in the Rotorua lakes. New Zealand Journal of Marine and Freshwater Research 53:555570.</li>
<li>Macrio et al (2015) New insights towards the establishment of phycocyanin concentration thresholds considering species-specific variability of bloom-forming cyanobacteria. Hydrobiologia 757:155165.</li>
</ul>


<br>

```{r}
algae.week=ddply(subset(sonde.dat.xtab,Date%in%date.fun(seq(End.Date-ddays(7),End.Date,"1 days"))),"Station.ID",summarise,
      mean.Chl=round(mean(CU,na.rm=T),0),mean.Phyco=round(mean(PU,na.rm=T),0))
algae.week$alge.score=with(algae.week,ifelse(mean.Chl<20,"Min. Concern",
                                             ifelse(mean.Chl>=40,"High Concern",
                                                    ifelse(mean.Chl>=20|mean.Chl<40,"Warning",
                                                           ifelse(mean.Chl>=20,"Concern",NA)))))
algae.week$BG.score=with(algae.week,ifelse(mean.Phyco<40,"Min. Concern",
                                             ifelse(mean.Phyco>=40,"High Concern",NA)))

cap.val=c("Weekly mean water quality sonde Chlorophyll and Phycocyanin concentration at monitoring locations across Lake Okeechobee")
algae.week%>%
  flextable()%>%
  align(j=2:5,align="center",part="all")%>%
  padding(padding=2,part="all")%>%
  font(fontname="Times New Roman",part="all")%>%
  fontsize(size=10,part="body")%>%
  fontsize(size=12,part="header")%>%
  bold(part="header")%>%
  set_header_labels("Station.ID"="Site",
                    "mean.Chl"="7-day Mean\nChlorophyll Conc.\n(\u03BCg L\u207B\u00B9)",
                    "mean.Phyco"="7-day Mean\nPhycocyanin Conc.\n(\u03BCg L\u207B\u00B9)",
                    "alge.score"="Green Algal\nConcern Category",
                    "BG.score"="Blue-green Algae\nConcern Category")%>%
  width(width=c(0.8,1.5,1.75,1.6,1.6))%>%
  bg(i=~alge.score=="Min. Concern",j=~alge.score,part="body",bg="green")%>%
  bg(i=~alge.score=="Warning",j=~alge.score,part="body",bg="yellow")%>%
  bg(i=~alge.score=="High Concern",j=~alge.score,part="body",bg="red")%>%
  bg(i=~BG.score=="Min. Concern",j=~BG.score,part="body",bg="green")%>%
  bg(i=~BG.score=="High Concern",j=~BG.score,part="body",bg="red")%>%
  footnote(j=2:3,part="header",value=as_paragraph(paste("Based on data from ",format(End.Date-ddays(7),"%m/%d/%Y")," - ",format(End.Date-ddays(1),"%m/%d/%Y"))),ref_symbols =c(" 1 "))%>%
  footnote(j=4,part="header",value=as_paragraph("Chlorophyll Categories:\nMin. Concern: values < 20 \u03BCg L\u207B\u00B9\nWarning: values \u2265 20\u03BCg L\u207B\u00B9 and <40 \u03BCg L\u207B\u00B9 \nHigh Concern: values \u2265 40 \u03BCg L\u207B\u00B9" ),ref_symbols=c(" 2 "))%>%
  footnote(j=5,part="header",value=as_paragraph("Phycocyanin Categories:\nMin. Concern: values < 40 \u03BCg L\u207B\u00B9\nHigh Concern: values \u2265 40 \u03BCg L\u207B\u00B9" ),ref_symbols=c(" 3 "))%>%
  add_header_lines(values=cap.val)%>%align(align="center",part="header")%>%fontsize(size=12,part="header")
  


```


### Algae Coverage
```{r noaa hab image,echo=F}
# 
# noaa.HAB=readLines("https://products.coastalscience.noaa.gov/habs_explorer/index.php?path=ajZiOVoxaHZNdE5nNytEb3RZdU5iVGZLZEU0cHZqYXlMWldYTlRDMWtEcz0=")
# 
# vals=grep("<section class='onecol habonecol'><a href='https://products.coastalscience.noaa.gov/habs_explorer/index.ph",noaa.HAB)
# 
# noaa.image.inventory=data.frame()
# # for(i in 1:6){
# for(i in 1:length(vals)){
#   tmp=noaa.HAB[vals[i]]
#   tmp2=strsplit(tmp,"<a|</a>")[[1]][4]
#   tmp3=strsplit(tmp2,"href=|title=|>")
#   
#   dat=data.frame(fileadd=sapply(tmp3,"[",2),filename=sapply(tmp3,"[",3))
#   
#   fname.vals=strsplit(dat$filename,"_")
#   dat$data.product=sapply(fname.vals,"[",length(fname.vals[[1]]))
#   
#   date.vals=strsplit(sapply(fname.vals,"[",1),"\\.")
#   yr.val=as.numeric(substr(sapply(date.vals,"[",2),1,4))
#   month.val=as.numeric(substr(sapply(date.vals,"[",3),1,2))
#   day.val=as.numeric(substr(sapply(date.vals,"[",3),3,4))
#   dat$date=as.Date(paste(yr.val,month.val,day.val,sep="-"))
#   
#   noaa.image.inventory=rbind(dat,noaa.image.inventory)
# }
# 
# noaa.HAB.image=subset(noaa.image.inventory,data.product=="CIcyano.LakeOkee.png'"&date==max(noaa.image.inventory$date))
```

```{r, out.width="100%",echo=FALSE,fig.align="center"}
# ,fig.cap=paste("Cyanobacteria Index for Lake Okeechobee for",noaa.HAB.image$date,"(Data Source: NOAA NCCOS)")
# knitr::include_graphics(noquote(gsub("'",'',noaa.HAB.image$fileadd)))
```

```{r, out.width="50%",echo=FALSE,fig.align="center"}
# knitr::include_graphics("https://nccospublicstor.blob.core.windows.net/hab-data/data/web/olci_fl_lake_o/legend.png")
```


```{r noaa hab data,echo=F,include=F}
LOK.area=area(lakeO)
noaa.HAB=readLines("https://products.coastalscience.noaa.gov/habs_explorer/index.php?path=ajZiOVoxaHZNdE5nNytEb3RZdU5iYjNnK3AvTWRrYmNWbXU0K0YvMlA1UlBtTWZlRFV3R1RicVRYb2pxeVJBUA==")

vals=grep("<section class='onecol habonecol'><a href='https://products.coastalscience.noaa.gov/habs_explorer/index.ph",noaa.HAB)

noaa.image.inventory=data.frame()
# for(i in 1:6){
for(i in 1:length(vals)){
  tmp=noaa.HAB[vals[i]]
  tmp2=strsplit(tmp,"<a|</a>")[[1]]
  tmp3=strsplit(tmp2[2],"href=|title=|>")
  tmp4=strsplit(tmp2[3],"</section>")
  
  dat=data.frame(fileadd=sapply(tmp3,"[",2),filename=sapply(tmp4,"[",1))
  
  fname.vals=strsplit(dat$filename,"_")
  if(trimws(substr(sapply(fname.vals,"[",1),1,9))!="sentinel"){next}else{
  dat$data.product=sapply(fname.vals,"[",length(fname.vals[[1]]))
  
  date.vals=strsplit(sapply(fname.vals,"[",1),"\\.")
  yr.val=as.numeric(substr(sapply(date.vals,"[",2),1,4))
  month.val=as.numeric(substr(sapply(date.vals,"[",3),1,2))
  day.val=as.numeric(substr(sapply(date.vals,"[",3),3,4))
  dat$date=as.Date(paste(yr.val,month.val,day.val,sep="-"))
  
  noaa.image.inventory=rbind(dat,noaa.image.inventory)
  }
}

noaa.HAB.image=subset(noaa.image.inventory,data.product=="3.CIcyano.LakeOkee.tif"&date==max(noaa.image.inventory$date))

data.path="./RSdata"
# data.path="C:/Julian_LaCie/_GitHub/CRE_Conditions/report/RSdata"

noaa.HAB.image=subset(noaa.image.inventory,data.product=="3.CIcyano.LakeOkee.tif")
# noaa.HAB.image$filename
noaa.HAB.image$fnames=with(noaa.HAB.image,paste0(format(date,"%Y%m%d"),"_LOK_CIcyano.tif"))
# fnames=with(noaa.HAB.image,paste0(format(date,"%Y%m%d"),"_LOK_CIcyano.tif"))

noaa.HAB.image=subset(noaa.HAB.image,fnames%in%list.files(data.path))

fnames=noaa.HAB.image$fnames

# # paste0(data.path,"sentinel_2022/", fnames)
# new.dat=fnames[fnames%in%list.files(data.path)==F]
# 
# # adjust timeout time
# options(timeout = max(300, getOption("timeout")))
# 
# noaa.HAB.image2=subset(noaa.HAB.image,fnames%in%new.dat)
# if(nrow(noaa.HAB.image2)!=0){
# for(i in 1:nrow(noaa.HAB.image2)){
# download.file(noquote(gsub("'", '', noaa.HAB.image2$fileadd[i], fixed=TRUE)),paste(data.path, noaa.HAB.image2$fnames[i],sep="/"),mode="wb",method="libcurl")
#   print(i)
# }
# }

cyano_area=data.frame()
for(i in 1:length(fnames)){
tmp.raster=raster(paste(data.path, fnames[i],sep="/"))


# plot(tmp.raster)
# plot(mask(tmp.raster,gBuffer(lakeO,width=500)))
tmp.raster=mask(tmp.raster,gBuffer(lakeO,width=500))
tmp.raster[tmp.raster==255]=NA; # No Data
# plot(tmp.raster)
# crs(tmp.raster)
# tmp.raster>250
# tmp.raster%in%c(250,251,253,254,255)
# 251 = CI adj; 252 = land; 253 = clouds; 254 = mixed pixels; 255 = No data; 0 = nodetect


cloud.area=tmp.raster>253
# cloud.area=tmp.raster[!tmp.raster%in%c(253,254,250)]
# cloud.area=tmp.raster%in%c(253)
cloud.area.raster=cloud.area
# cloud.area=cloud.area==1
cloud.area=cellStats(cloud.area,sum)*raster::res(cloud.area)[1]*raster::res(cloud.area)[2]

# remove cloud/no data values (see tif header)
# 0= nodetect
# 250 = saturated; 251 = ci adj; 252 = land; 253 = cloud;
# 254 = mixed pixel; 255 = no data

vals=c(0,250,251,252,253,254,255)
tmp.raster[tmp.raster%in%vals]=NA

tmp.raster=calc(tmp.raster,fun=function(x) x*1)
# ci.scale=calc(tmp.raster,fun=function(x) ci.scaling.fun(x))
rev.scale=calc(tmp.raster,fun=ci.reverse.scaling.fun)*100000000

area=rev.scale>0
val=cellStats(area,sum)*raster::res(area)[1]*raster::res(area)[2]
# val*3.86102e-7 # converts from m2 to mi2

area2=rev.scale>(1000*1000)
val2=cellStats(area2,sum)*raster::res(area2)[1]*raster::res(area2)[2]

tmp.rslt=data.frame(date=noaa.HAB.image$date[i],
                    cloud.area=cloud.area,
                    bloom.area.m2=val,
                    vis.bloom=val2)
cyano_area=rbind(cyano_area,tmp.rslt)

}

cyano_area$cloud.area.per=cyano_area$cloud.area/LOK.area
# cyano_area$bloom.area.m2.scn=with(cyano_area,ifelse(cloud.area.per>0.25,NA,bloom.area.m2))
cyano_area$bloom.area.mi2=cyano_area$bloom.area.m2*3.86102e-7
cyano_area$bloom.area.per=(cyano_area$bloom.area.m2/LOK.area)*100
cyano_area$date=date.fun(cyano_area$date)
cyano_area$date2=decdate.fun(cyano_area$date)
cyano_area$vis.bloom=cyano_area$vis.bloom*3.86102e-7


# tmp.raster=raster(paste(data.path, fnames[length(fnames)],sep="/"))
# tmp.raster=mask(tmp.raster,gBuffer(lakeO,width=500))
# vals=c(0,250,251,252,253,254,255)
# # tmp.raster_nodata=tmp.raster>=250
# tmp.raster[tmp.raster%in%vals]=NA

tmp.raster=calc(tmp.raster,fun=function(x) x*1)
rev.scale=calc(tmp.raster,fun=ci.reverse.scaling.fun)*100000000


date.val=subset(cyano_area,date==max(cyano_area$date))$date
algae.cov=subset(cyano_area,date==max(cyano_area$date))$bloom.area.mi2

## weather data
# wx.dates=date.fun(range(noaa.HAB.image$date))
# 
# dbkeys=data.frame(DBKEY=c("IY033","KV252"),param=c('WINVD','WINVS'))
# wx.dat=DBHYDRO_breakpoint(as.Date("2022-04-01"),as.Date("2022-07-18"),dbkeys$DBKEY)
# wx.dat=merge(wx.dat,dbkeys,'DBKEY')
# 
# wx.dat.xtab=cast(wx.dat,DATETIME~param,value="Data.Value",mean)
# 
# wx.dat.xtab$WINVS=wx.dat.xtab$WINVS*0.44704
# wx.dat.xtab$u_vec=with(wx.dat.xtab,-WINVS*sin(2*pi*(WINVD/360)))
# wx.dat.xtab$v_vec=with(wx.dat.xtab,-WINVS*cos(2*pi*(WINVD/360)))
# wx.dat.xtab$Date=date.fun(wx.dat.xtab$DATETIME)
# 
# wx.dat.xtab.da=ddply(wx.dat.xtab,"Date",summarise,
#                      mean.u.scalar=mean(WINVS,na.rm=T),
#                      mean.u=mean(u_vec,na.rm=T),
#                      mean.v=mean(v_vec,na.rm=T))
# wx.dat.xtab.da$wd.average=with(wx.dat.xtab.da,(atan2(mean.u,mean.v)*360/2/pi)+180)
# wx.dat.xtab.da$ws.vec.avg=with(wx.dat.xtab.da,((mean.u^2+mean.v^2)^0.5))
# 


```

<br>

```{r NOAA RS Plot,fig.width=6.5,fig.height=5,fig.align='center'}
par(family="serif",mar=c(0.5,0.5,0.5,0.5),oma=c(0.1,0.1,0.1,0.1));
layout(matrix(1:2,1,2,byrow = T),widths=c(1,0.4))

b=c(0,20,100,500,1000,6300)*1000
cols=viridisLite::turbo(249,direction=1)
plot(lakeO,lwd=0.05)
plot(lakeO.lit,lwd=0.05,col=adjustcolor("honeydew2",0.5),border=NA,add=T)
plot(lakeO,lwd=0.05,add=T)
image(rev.scale,add=T,col = cols)
image(cloud.area.raster,add=T,col=c(NA,"grey"))
if(sum(is.na(getValues(rev.scale)))/length(getValues(rev.scale))<0.75){
plot(rasterToContour(rev.scale,levels=b,nlevels=length(b)),col="black",lwd=2,add=T)}
mapmisc::scaleBar(utm17,"bottomright",bty="n",cex=1,seg.len=4,outer=F)
mtext(side=3,line=-2.5,adj=0,paste("Date:",format(date.val,"%m-%d-%Y"),
                                   "\nData Source: NOAA NCCOS\nAlgae Coverage:",
                                   round(algae.cov),"mi\u00B2"))


plot(0:1,0:1,ann=F,axes=F,type="n")
b2=b/1000
l.b=length(b2)
labs=b2
n.bks=length(b2) -1
top.val=0.8
bot.val=0.2
mid.v.val=bot.val+(top.val-bot.val)/2
x.max=0.3
x.min=0
mid.val=x.min+(x.max-x.min)/2
txt.offset.val=-0.01
lab.pos=seq(bot.val,top.val,length.out=l.b)
legend_image=as.raster(matrix(rev(cols),ncol=1))
rasterImage(legend_image,x.min,bot.val,x.max,top.val)
text(x=x.max, y = lab.pos, labels = format(b2),cex=0.75,adj=0,pos=4,offset=0.5)
segments(rep(x.min,l.b),lab.pos,rep(x.max,l.b),lab.pos,lwd=2)
#add cloud
legend_image=as.raster(matrix("grey",ncol=1))
rasterImage(legend_image,x.min,bot.val-0.05,x.max,bot.val)
text(x=x.max, y = bot.val-0.025, labels = "Clouds/Invalid data",cex=0.5,adj=0,pos=4,offset=0.5)

legend_image=as.raster(matrix(adjustcolor("honeydew2",0.5),ncol=1))
rasterImage(legend_image,x.min,bot.val-0.1,x.max,bot.val-0.05)
text(x=x.max, y = bot.val-0.075, labels = "Littoral Zone",cex=0.5,adj=0,pos=4,offset=0.5)
# bx.val= seq(bot.val,top.val,(top.val-bot.val)/n.bks)
# rect(x.min,bx.val[1:n.bks],x.max,bx.val[2:(n.bks+1)],col=rev(col.rmp),lty=0)
# text(y=bx.val[2:(n.bks+1)]-c(mean(diff(bx.val[2:(n.bks+1)]))/2), x = x.max, labels = rev(labs),cex=0.75,xpd=NA,pos=4,adj=0)
text(x=mid.val,y=top.val,expression(paste("CI"["Cyano"]," (cells mL"^"-1","x1000)")),adj=0,cex=0.8,pos=3,xpd=NA)

logo=png::readPNG("./Logo no Background.png")
grid::grid.raster(logo,x=0.825,y=0.12,just=c("center","top"),width=grid::unit(1.25,"inches"))
```

<font size=2><center>Cyanobacteria Algal Index across Lake Okeechobee. Data from NOAA NCCOS HAB data explorer.</center></font><font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

<br>

```{r NOAA LOK area,fig.width=6.5,fig.height=5,fig.align='center'}
par(family="serif",mar=c(1,3,0.5,2),oma=c(2,2,0.5,2))
layout(matrix(1:2,2,1),heights=c(0.5,1))

xlim.val=c(date.fun("2022-04-01"),date.fun(Sys.Date()+lubridate::duration(1,"months")));xmaj=seq(xlim.val[1],xlim.val[2],"1 months");xmin=seq(xlim.val[1],xlim.val[2],"1 days")

# ylim.val=c(-10,10);by.y=5;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
# plot(ws.vec.avg~Date,wx.dat.xtab.da,axes=F,ann=F,type="n",ylim=ylim.val,xlim=xlim.val)
# abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.75)
# abline(h=0)
# stickplot.dat.arrows(Date,ws.vec.avg,wd.average,wx.dat.xtab.da,col="dodgerblue1",lty=1,lwd=2)
# axis_fun(2,ymaj,ymin,ymaj)
# # axis_fun(1,xmaj,xmin,format(xmaj,"%m-%Y"))
# axis_fun(1,xmaj,xmin,NA)
# box(lwd=1)
# mtext(side=2,line=2.5,"Avg Wind Speed & Dir\n(m s\u207B\u00B9)")
# mtext(side=3,adj=1,"Data Source: SFWMD",font=3)
# mtext(side=3,adj=0,"Station: LZ40",font=3)

ylim.val=c(0,1);by.y=0.2;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(cloud.area.per~date,cyano_area,axes=F,ann=F,type="n",ylim=ylim.val,xlim=xlim.val,yaxs="i")
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.75)
with(cyano_area,pt_line(date,cloud.area.per,2,"grey",2,21,"grey"))
axis_fun(2,ymaj,ymin,ymaj*100)
# axis_fun(1,xmaj,xmin,format(xmaj,"%m-%Y"))
axis_fun(1,xmaj,xmin,NA)
box(lwd=1)
mtext(side=2,line=2.5,"Cloud Cover (%)")
mtext(side=3,adj=1,"Data Source: NOAA NCCOS",font=3)
mtext(side=3,adj=0,"Lake Okeechobee",font=3)

ylim.val=c(0,max(cyano_area$bloom.area.mi2)*1.10);by.y=100;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
plot(cloud.area.per~date,cyano_area,axes=F,ann=F,type="n",ylim=ylim.val,xlim=xlim.val,yaxs="i")
abline(h=ymaj,v=xmaj,lty=3,col="grey",lwd=0.75)
with(cyano_area,pt_line(date,bloom.area.mi2,1,"dodgerblue1",2,21,"dodgerblue1",pt.lwd=0.1,cex=1.25))
with(subset(cyano_area,date==max(cyano_area$date)),
     text(date,bloom.area.mi2,paste0(round(bloom.area.mi2)," mi\u00B2\n(",round(bloom.area.per),"%)"),pos=4,offset=0.5,cex=0.75))
# with(cyano_area,pt_line(date,vis.bloom,2,
#                         adjustcolor("grey",0.5),2,21,adjustcolor("grey",0.5),pt.lwd=0.1,cex=1.25))
k.mod=loess(bloom.area.mi2~date2,subset(cyano_area,bloom.area.mi2>0&cloud.area.per<0.30))
x.val=seq(min(cyano_area$date2),max(cyano_area$date2),length.out=100)
pred.mod=predict(k.mod,data.frame(date2=x.val))
lines(date.fun(lubridate::date_decimal(x.val),form="%F %R"),pred.mod,col="red",lwd=2)
axis_fun(2,ymaj,ymin,ymaj)
axis_fun(1,xmaj,xmin,format(xmaj,"%b-%Y"),line=-0.5)
axis_fun(1,xmaj,xmin,NA)
box(lwd=1)
mtext(side=1,line=1.5,"Date (Month-Year)")
mtext(side=2,line=2.5,"Cyanobacteria Algal Bloom\ncoverage (mi\u00B2)")
axis_fun(4,ymaj,ymin,round((ymaj/(LOK.area*3.861e-7))*100,0))
mtext(side=4,line=2.5,"Cyanobacteria Algal Bloom\ncoverage (% LOK)")
legend("topleft",legend=c("Smoothed Trend"),
       lty=c(1),lwd=c(1),col=c("red"),
       pch=c(NA),pt.bg=c(NA),
       pt.cex=1.25,ncol=1,cex=0.75,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0)
```

<font size=2><center>Average daily windspeed and direction and cyanobacteria algal bloom coverage of Lake Okeechobee. Data from NOAA NCCOS HAB data explorer.</center></font><font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

### Blue-Green Algae Sampling Results

```{r FDEP BGAlgae}

# Blue-Green Algae --------------------------------------------------------
sdate.algae=date.fun(TODAY-lubridate::duration(30,"days"))
# path <- 'https://services1.arcgis.com/nRHtyn3uE1kyzoYc/arcgis/rest/services/VIEW_FL_Algal_Bloom_Site_Visits_1/FeatureServer/0/query?'

path <- 'https://services1.arcgis.com/nRHtyn3uE1kyzoYc/arcgis/rest/services/AlgalBloom_Final_View/FeatureServer/0/query?'

request <- GET(
  url = path,
  query= list(       
    where = "County='Lee' OR County='Collier' OR County='Hendry' OR County='Glades' OR County='Martin'",
    outFields = '*',
    f = 'pjson'
  )
)
response <- content(request, as = "text", encoding = "UTF-8")
results <- jsonlite::fromJSON(response,flatten=T)
# nrow(results$features)

bgdat=results$features

request <- GET(
  url = path,
  query= list(       
    where = "County='Okeechobee' OR County='PalmBeach' OR County='Broward' OR County='MiamiDade' OR County='Monroe'",
    outFields = '*',
    f = 'pjson'
  )
)
response <- content(request, as = "text", encoding = "UTF-8")
results <- jsonlite::fromJSON(response,flatten=T)
# nrow(results$features)

bgdat=rbind(bgdat, results$features)
# unique(bgdat$attributes.County)

# vars=c("attributes.objectid", "attributes.globalid", "attributes.SiteVisitDate", 
#        "attributes.Location", "attributes.County", "attributes.Visitor", 
#        "attributes.AlgaeObserved", "attributes.SampleTaken", "attributes.DepthDesc", 
#        "attributes.SampleDepth", "attributes.AnalyzedBy", "attributes.Otherlab", 
#        "attributes.Comments", "attributes.Latitude", "attributes.Longitude", 
#        "attributes.AlgalID", "attributes.Microcystin", "attributes.OtherToxin", 
#        "attributes.EditDate", "attributes.PicURL", "attributes.ToxinPresent", 
#        "attributes.CyanobacteriaDominant", "geometry.x", "geometry.y"
# )
vars=c("attributes.objectid", "attributes.globalid", 
       "attributes.SampleDateTime", "attributes.MonitoringGroupPublicFacing",
       "attributes.County", "attributes.esrignss_latitude", 
       "attributes.esrignss_longitude", "attributes.BloomObserved", 
       "attributes.Comments", "attributes.MeterReadingsOnly", 
       "attributes.SampleDepthDesc", "attributes.AnalyzedBy", 
       "attributes.Otherlab", "attributes.SampleDepth", 
       "attributes.AlgalIDResult", "attributes.ToxinPresent", 
       "attributes.Microcystin", "attributes.OtherToxin", 
       "attributes.locationString", "attributes.EditDate", 
       "attributes.PicURL","attributes.CyanobacteriaDominant",
       "geometry.x", "geometry.y")

vars=strsplit(vars,"\\.")
vars=sapply(vars,"[",2)
vars[vars%in%c("esrignss_longitude","esrignss_latitude")]=c("latitude","longitude")
colnames(bgdat)<-tolower(vars)

# bgdat$sitevisitdate=as.numeric(gsub('000$', '',format(bgdat$sitevisitdate,scientific=F)))
bgdat$sitevisitdate=as.numeric(gsub('000$', '',format(bgdat$sampledatetime,scientific=F)))
bgdat$datetime=as.POSIXct(bgdat$sitevisitdate,origin = c('1970-01-01'), tz = 'UTC')
bgdat$datetime=date.fun(bgdat$datetime,form="%F %R")
bgdat$date=date.fun(bgdat$datetime)

# Fix microcystin value
vars=strsplit(bgdat$microcystin,"\\ |\\(")
# bgdat$microcystin.halfmdl=ifelse(sapply(vars,"[",1)=="not detected",0.5,as.numeric(sapply(vars,"[",1)))
bgdat$microcystin.val=ifelse(sapply(vars,"[",1)=="not",NA,as.numeric(sapply(vars,"[",1)))

# bgdat_30d=subset(bgdat,date<=TODAY&date>=sdate.algae)
# bgdat_30d.shp=SpatialPointsDataFrame(coords=bgdat_30d[,c("longitude","latitude")],
#                                               data=bgdat_30d,
#                                               proj4string = wgs84)

bgdat.shp=SpatialPointsDataFrame(coords=bgdat[,c("longitude","latitude")],
                                              data=bgdat,
                                              proj4string = wgs84)
bgdat.ext=as(extent(bgdat),"SpatialPolygons")
proj4string(bgdat.ext)=wgs84
bgdat.ext=SpatialPolygonsDataFrame(bgdat.ext,data.frame(ID="BGdata"))

bgdat_30d.shp=subset(bgdat.shp,date<=TODAY&date>=sdate.algae)
bgdat_30d=bgdat_30d.shp@data
```


```{r BG_map30d,fig.width=7,fig.height=5,fig.align='center'}
par(family="serif",oma=c(0.25,0.25,0.25,0.25),mar=c(0.1,0.1,0.1,0.1),xpd=F)
# layout(matrix(c(1:2),1,2,byrow=T),widths = c(1,0.3))
# par(family="serif",mar=c(0.1,0.1,0.1,0.1),oma=c(0.5,0.5,0.5,0.5));
layout(matrix(1:2,1,2,byrow=F),widths=c(1,0.5))
bbox.lims=bbox(bgdat.ext)

plot(shore,col="cornsilk",border="grey",bg="lightblue",ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=0.01)
if(nrow(bgdat_30d.shp)!=0){
plot(subset(bgdat_30d.shp,is.na(toxinpresent)==T),add=T,pch=21,bg="grey",cex=1)
plot(subset(bgdat_30d.shp,toupper(toxinpresent)=="NO"),add=T,pch=21,bg="green",cex=2,lwd=0.1)
plot(subset(bgdat_30d.shp,toupper(toxinpresent)=="YES"),add=T,pch=21,bg="red",cex=2,lwd=0.1)
}
box(lwd=1)
mapmisc::scaleBar(wgs84,"bottomleft",bty="n",cex=1,seg.len=4,outer=F)

plot(0:1,0:1,ann=F,axes=F,type="n")
date.rng=range(bgdat_30d.shp$date,na.rm=T)
legend("center",legend=c("Toxin Present","Toxin Not Present","No Data"),
       pch=c(21),lty=c(NA),lwd=c(0.1),
       col=c("black"),pt.bg=c("red","green","grey"),
       pt.cex=1.25,ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=1,
       title.adj = 0,title=paste0("Blue-green Algae Toxin status\n",format(date.rng[1],"%b %d,%Y")," to ",format(date.rng[2],"%b %d,%Y"),"\n(Presence/Absence)"))

```


```{r,out.width='100%'}
# tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
#   tm_shape(bgdat_30d.shp)+tm_bubbles(col="white",
#                                      size="microcystin.val", id="date",group="Microcystin conc.")+
#   tm_shape(bgdat_30d.shp)+tm_dots(col="toxinpresent",
#                                 palette =c("green","red"),
#                                 colorNA="grey",
#                                 size=0.03,
#                                 id="date",
#                                 popup.vars=c("date","visitor","depthdesc",
#                                              "microcystin",
#                                              "cyanobacteriadominant","toxinpresent",
#                                              "algalid","othertoxin"),
#                                 group="FDEP Blue-green Algae Data",
#                                 title="Cyanobacteria dominate")+
#   
#   tm_shape(bgdat.ext)+tm_borders(group="Area of Interest",lty="dashed",col="grey",lwd=1)

```

<font size=2><center>Blue-green Algae sampling results for the last 30-days for the 10 county area (Lee, Collier, Hendry, Glades, Okeechobee, Martin, Palm Beach, Broward, Miami-Dade and Monroe). Data from FDEP Blue-green algae dashboard</center></font><font size=3 color="red"><center>Data are provisional and subject to change.</center></font>
 
Of the `r nrow(bgdat_30d)` samples collected, cyanobacteria was dominate in `r sum(bgdat_30d$cyanobacteriadominant=="Yes",na.rm=T)` samples, `r sum(bgdat_30d$toxinpresent=="Yes",na.rm=T)` samples had toxins present ranging from `r min(as.numeric(bgdat_30d$microcystin.val),na.rm = T)` to `r max(as.numeric(bgdat_30d$microcystin.val),na.rm = T)` `r paste0("\u03BCg L\u207B\u00B9")` (does not include non-detects). 


<br>


***

## Caloosahatchee River Estuary

### Discharge


```{r CRE_Q, echo=FALSE,fig.width=6,fig.height=4,fig.align='center'}
# RECON.dates=date.fun(c(Sys.Date()-duration(6, "months"),date.fun(Sys.Date())))
RECON.dates=date.fun(c(Sys.Date()-duration(1, "years"),date.fun(Sys.Date())))
# RECON.dates
dates.fill=data.frame(DATE=seq(RECON.dates[1],RECON.dates[2],"1 days"),fill=1)

# dat.recon=read.csv("C:/Julian_LaCie/_Github/CRE_Conditions/Data/stakeholder/chart.csv")
# dat.recon$DateTime=date.fun(dat.recon$DateTime,form="%F %X")
# dat.recon$Date=date.fun(dat.recon$DateTime)
# colnames(dat.recon)=c("DATETIME","Sal","DATE")
# dat.recon$source="RECON"
# RECON.dates=date.fun(range(dat$DateTime))
# da.dat.recon=ddply(dat.recon,"DATE",summarise,mean.val=mean(Sal,na.rm=T))
# da.dat.recon$Sal.30d=with(da.dat.recon,c(rep(NA,29),rollapply(mean.val,width=30,FUN=function(x)mean(x,na.rm=T))))

## replace RECON till fix
bk.dbkeys.surf=data.frame(depth="Surface",
                         SITE=c(rep("FORTMYERSM",2)),
                         param=rep(c("WT","SPC"),1),
                         DBKEY=c("88287","88292")
                         )
dat=data.frame()
for(i in 1:nrow(bk.dbkeys.surf)){
tmp=DBHYDRO_breakpoint(RECON.dates[1],RECON.dates[2],bk.dbkeys.surf$DBKEY[i])  
tmp$DBKEY=as.character(bk.dbkeys.surf$DBKEY[i])
dat=rbind(dat,tmp)
# print(i)
}
dat=merge(dat,bk.dbkeys.surf,"DBKEY")
dat$Data.Value[dat$Data.Value==-999]<-NA
dat.xtab=data.frame(cast(dat,SITE+DATETIME+DATE~param,value="Data.Value",mean))
dat.xtab$Sal=with(dat.xtab,SalinityCalc(SPC,WT))
dat.xtab$source="SFWMD"
# da.dat=ddply(dat.xtab,"DATE",summarise,mean.val=mean(Sal,na.rm=T))
# da.dat$Sal.30d=with(da.dat,c(rep(NA,29),rollapply(mean.val,width=30,FUN=function(x)mean(x,na.rm=T))))

# vars=c("DATETIME","DATE","Sal","source")
# dat.xtab.comb=rbind(dat.xtab[,vars],dat.recon[,vars])
# dat.xtab2=cast(dat.xtab.comb,DATETIME+DATE~source,value="Sal",mean)
# dat.xtab2$Sal=with(dat.xtab2,ifelse(is.na(RECON)==T,SFWMD,RECON))
# dat.xtab2=merge(dat.xtab2,dates.fill,"DATE",all.y=T)
da.dat=ddply(dat.xtab,"DATE",summarise,mean.val=mean(Sal,na.rm=T))
#da.dat$Sal.30d=with(da.dat,c(rep(NA,29),rollapply(mean.val,width=30,FUN=function(x)mean(x,na.rm=T))))
da.dat$Sal.30d=with(da.dat,roll_meanr(mean.val,n=30))
#da.dat=merge(da.dat,dates.fill,"DATE",all.y=T)

cal.dbkeys=data.frame(DBKEY=c("DJ237","00865"),priority=c("P1","P2"))
cal.q=DBHYDRO_daily(RECON.dates[1]-duration(2,"months"),RECON.dates[2],cal.dbkeys$DBKEY)
cal.q$Date=date.fun(cal.q$Date)
cal.q=merge(cal.q,cal.dbkeys,"DBKEY")
cal.q=cast(cal.q,Date~priority,value="Data.Value",mean)
cal.q$Data.Value=with(cal.q,ifelse(is.na(P1)==T,P2,P1))
cal.q$Q.30=with(cal.q,roll_meanr(Data.Value,n=30))
#cal.q$Q.30=with(cal.q,c(rep(NA,29),rollapply(Data.Value,width=30,FUN=function(x)mean(x,na.rm=T))))

ylim.val=c(0,30);by.y=5;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.val=c(date.fun(RECON.dates[2]-duration(6, "months")),date.fun(RECON.dates[2]+duration(15,"days")));xmaj=seq(xlim.val[1],xlim.val[2],by="2 months ");xmin=seq(xlim.val[1],xlim.val[2],by="1 months")

par(family="serif",cex.axis=1.2,mar=c(3.5,1.75,1,4.5),oma=c(0.5,3,1,2));
plot(Sal~DATETIME,dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
# with(dat,lines(DateTime,Sal,lty=1,col="blue",lwd=1.5))
# with(da.dat,lines(Date,Sal.30d,lty=1,col="darkolivegreen3",lwd=2))
with(dat.xtab,lines(DATETIME,Sal,lty=1,col="blue",lwd=2))
with(da.dat,lines(DATE,Sal.30d,lty=1,col="darkolivegreen3",lwd=4))
axis_fun(1,xmaj,xmin,NA)
axis_fun(2,ymaj,ymin,ymaj)
text(xmaj,-1.5,format(xmaj,"%m/%d/%y"),srt=-45,xpd=NA,adj=0,cex=0.95)
mtext(side=2,line=2,"Salinity (PSU)")
mtext(side=1,line=3,"Date (MM/DD/YY)")
ylim.val=c(0,20000);by.y=4000;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
par(new=T);plot(Data.Value~Date,cal.q,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
with(cal.q,lines(Date,Data.Value,lwd=2,col="black"))
with(cal.q,lines(Date,Q.30,lwd=4,col="indianred1"))
# abline(h=475,lty=2,col="red")
axis_fun(4,ymaj,ymin,ymaj)
mtext(side=4,line=3.25,"Discharge (cfs)")
mtext(side=3,"Surface Salinity at Fort Myers Yacht Basin")

# legend("topright",
#        legend=c("Hourly Salinity","30-Day Avg Sal","S79 Daily Discharge","30-d Avg Discharge","MFL (40E-8.221(2) FAC)"),
#        lty=c(1,1,1,1,2),lwd=c(1,2,1,2,1),
#        col=c("blue","darkolivegreen3","black","indianred1","red"),
#        ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5)
legend("topright",
       legend=c("Hourly Salinity","30-Day Avg Sal","S79 Daily Discharge","30-d Avg Discharge"),
       lty=c(1,1,1,1),lwd=c(1,2,1,2),
       col=c("blue","darkolivegreen3","black","indianred1"),
       ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5)
logo=png::readPNG("./Logo no Background.png")
grid.raster(logo,x=0.16,y=0.9,just=c("left","top"),width=unit(1.25,"inches"))
```

<font size=2><center>Fort Myers Yacht Basin salinity (SCCF-RECON) and S79 discharge (SFWMD) data for the last six months.</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

```{r CRE_Q_30d,echo=FALSE,fig.width=6,fig.height=4,fig.align='center'}
seq.30d=seq(date.fun(RECON.dates[2]-duration(30,"days")),date.fun(RECON.dates[2]+duration(15,"days")),"1 days")

max.ylim.2=round(max(subset(cal.q,Date%in%seq.30d)$Data.Value,na.rm=T)+max(subset(cal.q,Date%in%seq.30d)$Data.Value,na.rm=T)*0.25,-3)

ylim.val=c(0,30);by.y=5;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.val=c(date.fun(RECON.dates[2]-duration(30,"days")),date.fun(RECON.dates[2]+duration(15,"days")));xmaj=seq(xlim.val[1],xlim.val[2],by="14 days ");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")

par(family="serif",cex.axis=1.2,mar=c(3.5,1.75,1,4.5),oma=c(0.5,3,1,2));
plot(Sal~DATETIME,dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
# with(dat,lines(DateTime,Sal,lty=1,col="blue",lwd=1.5))
# with(da.dat,lines(Date,Sal.30d,lty=1,col="darkolivegreen3",lwd=2))
with(dat.xtab,lines(DATETIME,Sal,lty=1,col="blue",lwd=2))
with(da.dat,lines(DATE,Sal.30d,lty=1,col="darkolivegreen3",lwd=4))
axis_fun(1,xmaj,xmin,NA)
axis_fun(2,ymaj,ymin,ymaj)
text(xmaj,-1.5,format(xmaj,"%m/%d/%y"),srt=-45,xpd=NA,adj=0,cex=0.95)
mtext(side=2,line=2,"Salinity (PSU)")
mtext(side=1,line=3,"Date (MM/DD/YY)")
ylim.val=c(0,max.ylim.2);by.y=max.ylim.2/4;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
par(new=T);plot(Data.Value~Date,cal.q,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
with(cal.q,lines(Date,Data.Value,lwd=2,col="black"))
with(cal.q,lines(Date,Q.30,lwd=4,col="indianred1"))
abline(h=475,lty=2,col="red")
text(date.fun(xlim.val[2]-ddays(6)),475,"MFL (30d Q)",font=2,cex=0.75,col="red",pos=3)
axis_fun(4,ymaj,ymin,ymaj)
mtext(side=4,line=3.25,"Discharge (cfs)")
mtext(side=3,"Surface Salinity at Fort Myers Yacht Basin")

legend("topright",
       legend=c("Hourly Salinity","30-Day Avg Sal","S79 Daily Discharge","30-d Avg Discharge","MFL (40E-8.221(2) FAC)"),
       lty=c(1,1,1,1,2),lwd=c(1,2,1,2,1),
       col=c("blue","darkolivegreen3","black","indianred1","red"),
       ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5)
logo=png::readPNG("./Logo no Background.png")
grid.raster(logo,x=0.16,y=0.9,just=c("left","top"),width=unit(1.25,"inches"))

```

<font size=2><center>Fort Myers Yacht Basin salinity (SCCF-RECON) and S79 discharge (SFWMD) data for the last last 30 days.</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>

```{r Caloosa Data_Flow, include=FALSE}
cal.flow=data.frame(DBKEY=c("DJ235","88280","DJ237","00865"),SITE=c(rep("S77",2),rep("S79",2)),priority=rep(c("P1","P2"),2))
cal.flow.dat=data.frame()
for(i in 1:nrow(cal.flow)){
  tmp=DBHYDRO_daily(date.fun(paste(CurWY-3,"05-01",sep="-")),End.Date,cal.flow$DBKEY[i])
  tmp$DBKEY=as.character(cal.flow$DBKEY[i])
  cal.flow.dat=rbind(tmp,cal.flow.dat)
}
cal.flow.dat$Date=date.fun(cal.flow.dat$Date)
cal.flow.dat$WY=WY(cal.flow.dat$Date)
cal.flow.dat=merge(cal.flow.dat,cal.flow,"DBKEY")
cal.flow.dat.xtab=cast(cal.flow.dat,SITE+Date+WY~priority,value="Data.Value",mean)
cal.flow.dat.xtab$P1=with(cal.flow.dat.xtab,ifelse(SITE=="S77"&P1>=7587,NA,P1)); #Extreme value reported for 6/7/2021
cal.flow.dat.xtab$Data.Value=with(cal.flow.dat.xtab,ifelse(is.na(P1)==T,P2,P1))

cal.flow.dat.xtab=cast(cal.flow.dat.xtab,Date+WY~SITE,value="Data.Value",mean)
cal.flow.dat.xtab$hydro.day=hydro.day(cal.flow.dat.xtab$Date)
cal.flow.dat.xtab$S77=with(cal.flow.dat.xtab,ifelse(S77<0,0,S77))
cal.flow.dat.xtab$C43=with(cal.flow.dat.xtab,ifelse(S79<S77,0,S79-S77))

cal.flow.dat.xtab$cum.S79=with(cal.flow.dat.xtab,ave(cfs.to.acftd(S79),WY,FUN = function(x)cumsum(ifelse(is.na(x),0,x))))
cal.flow.dat.xtab$cum.S77=with(cal.flow.dat.xtab,ave(cfs.to.acftd(S77),WY,FUN = function(x)cumsum(ifelse(is.na(x),0,x))))
cal.flow.dat.xtab$Q.14=with(cal.flow.dat.xtab,roll_meanr(S79,n=14))
cal.flow.dat.xtab$Q.30=with(cal.flow.dat.xtab,roll_meanr(S79,n=30))
cal.flow.dat.xtab$SalEnv.cat=with(cal.flow.dat.xtab,ifelse(Q.14<750,"low",
                                                           ifelse(Q.14>=750&Q.14<2100,"optimum",
                                                                  ifelse(Q.14>=2100&Q.14<2600,"stress",
                                                                         ifelse(Q.14>2600,"damaging",NA)))))
# cal.flow.dat.xtab$Q.30=with(cal.flow.dat.xtab,c(rep(NA,29),rollapply(S79,width=30,FUN=function(x)mean(x,na.rm=T))))

# cal.flow.dat.xtab$Q.14>2600

```



```{r CRE_LOK_Q, echo=FALSE,fig.width=7,fig.height=5,fig.align='center'}

max.q=max(subset(cal.flow.dat.xtab,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$S79,na.rm=T)
ylim.max=round(max.q+max.q*0.25,-3)

ylim.val=c(0,ylim.max);by.y=ylim.max/4;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.val=date.fun(c(TODAY-ddays(30),TODAY+ddays(3)));xmaj=seq(xlim.val[1],xlim.val[2],by="7 days");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")
cols=c("dodgerblue1","indianred1","black")

layout(matrix(1:2,2,1,byrow=F),widths=c(2,1),heights=c(2,0.4))
par(family="serif",cex.axis=1.2,mar=c(2,2,1,1),oma=c(0.5,3,1,2));
plot(S79~Date,cal.flow.dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(cal.flow.dat.xtab,lines(Date,S79,col=cols[1],lwd=2))
with(cal.flow.dat.xtab,lines(Date,S77,col=cols[2],lwd=2,lty=2))
with(cal.flow.dat.xtab,lines(Date,C43,col=cols[3],lwd=2,lty=3))
axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d/%Y"),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj,cex.axis=1)
box(lwd=lwd.val)
mtext("Date\n(MM/DD/YYYY)",side=1,line=2.75,cex=1.25)
mtext("Daily Discharge (cfs)",side=2,line=3.5,cex=1.25)

plot(0:1,0:1,type="n",yaxt="n",xaxt="n",bty="n")
legend(0.5,0.5,
       legend=c("S-79 (to Estuary)","S-77 (from Lake)","C-43 Basin Flow"),
       col=cols,lty=c(1,2,3),lwd=c(2.5,2.5,2.5),pt.cex=2.5,ncol=3,cex=1.25,bty="n",y.intersp=1,x.intersp=0.5,xpd=NA,xjust=0.5)

```

<font size=3><center>S-77 (from Lake Okeechobee) and S-79 (to Tidal Basin) flow data along the C-43 and Caloosahatchee River. C-43 Basin Flow was calculated as the difference from S-77 and S-79.</center></font>
<font size=4 color="red"><center>Data are provisional and subject to change.</center></font>

<br>

```{r CRE_SalEnv6mon, echo=FALSE,fig.width=7,fig.height=5,fig.align='center'}
# ylim.max=signif(max(subset(cal.flow.dat.xtab,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$S79,na.rm=T)+max(cal.flow.dat.xtab$S79,na.rm=T)*0.1,0)

max.q=max(subset(cal.flow.dat.xtab,Date%in%seq(date.fun(TODAY-duration(6,"months")),date.fun(TODAY+ddays(3)),"1 days"))$S79,na.rm=T)
ylim.max=round(max.q+max.q*0.1,-3)

ylim.val=c(0,ylim.max);by.y=ylim.max/4;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.val=date.fun(c(TODAY-duration(6,"months"),TODAY+ddays(3)));xmaj=seq(xlim.val[1],xlim.val[2],by="2 month");xmin=seq(xlim.val[1],xlim.val[2],by="1 months")

layout(matrix(1:2,2,1,byrow=F),widths=c(2,1),heights=c(1,0.5))
par(family="serif",cex.axis=1.2,mar=c(2,2,1,2),oma=c(0.5,3,1,2));
plot(S79~Date,cal.flow.dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
xx=c(xlim.val[1],xlim.val[1],xlim.val[2],xlim.val[2])
yy3=c(2600,ylim.max,ylim.max,2600);polygon(x=xx,y=yy3,col=adjustcolor("red",0.5))
yy4=c(2100,2600,2600,2100);polygon(x=xx,y=yy4,col=adjustcolor("yellow",0.5))
yy5=c(750,2100,2100,750);polygon(x=xx,y=yy5,col=adjustcolor("green",0.5))
abline(h=ymaj,v=xmaj,lty=3,col="grey")
abline(h=457,col="red")
with(cal.flow.dat.xtab,pt_line(Date,S79,2,"black",1,21,"grey",cex=1,pt.lwd=0.1))
with(cal.flow.dat.xtab,lines(Date,Q.14,lwd=3,col=adjustcolor("dodgerblue3",0.5)))
with(cal.flow.dat.xtab,lines(Date,Q.30,lwd=3,col=adjustcolor("black",0.5),lty=2))
axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d/%Y"),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj,cex.axis=1)
axis_fun(4,ymaj,ymin,format(round(cfs.to.acftd(ymaj)/1000,1)),cex.axis=1)

box(lwd=lwd.val)
mtext("Date\n(MM/DD/YYYY)",side=1,line=2.75,cex=1.25)
mtext("Discharge (cfs)",side=2,line=3.5,cex=1.25)
mtext("Discharge (kAc-Ft D\u207B\u00B9)",side=4,line=2.5,cex=1.25)

plot(0:1,0:1,type="n",yaxt="n",xaxt="n",bty="n")
legend(0.25,0.75,
       legend=c( "Damaging (>2600 cfs)","Stress (2100 - 2600 cfs)","Optimum (750 - 2100 cfs)"),pch=22,
       pt.bg=adjustcolor(c("red","yellow","green"),0.5),pt.cex=2,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5,title.adj = 0,title='RECOVER PM')

legend(0.75,0.75,
       legend=c("Daily Discharge","14-Day moving average","30-Day moving average","MFL (40E-8.221(2) FAC)"),
       pch=c(21,NA,NA,NA),pt.bg=c("grey",NA,NA,NA),pt.cex=c(1.5,NA,NA,NA),lty=c(NA,1,2,1),lwd=c(0.5,2,2,1),col=c("black",adjustcolor(c("dodgerblue1","black"),0.5),"red"),
       ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5,title.adj = 0,title='')

```

<font size=3><center>Daily, 14-day moving average and 30-day moving average discharge for S-79 relative to the Northern Estuaries RECOVER performance measure and the established minimium flows and levels (MFLs) for the recent 6-month period.</center></font>
<font size=4 color="red"><center>Data are provisional and subject to change.</center></font>


```{r CRE_SalEnv30d, echo=FALSE,fig.width=7,fig.height=5,fig.align='center'}
# ylim.max=signif(max(subset(cal.flow.dat.xtab,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$S79,na.rm=T)+max(cal.flow.dat.xtab$S79,na.rm=T)*0.1,0)

max.q=max(subset(cal.flow.dat.xtab,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$S79,na.rm=T)
ylim.max=round(max.q+max.q*0.25,-3)

ylim.val=c(0,ylim.max);by.y=ylim.max/4;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.val=date.fun(c(TODAY-ddays(30),TODAY+ddays(3)));xmaj=seq(xlim.val[1],xlim.val[2],by="7 days");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")

layout(matrix(1:2,2,1,byrow=F),widths=c(2,1),heights=c(1,0.5))
par(family="serif",cex.axis=1.2,mar=c(2,2,1,2),oma=c(0.5,3,1,2));
plot(S79~Date,cal.flow.dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
xx=c(xlim.val[1],xlim.val[1],xlim.val[2],xlim.val[2])
yy3=c(2600,ylim.max,ylim.max,2600);polygon(x=xx,y=yy3,col=adjustcolor("red",0.5))
yy4=c(2100,2600,2600,2100);polygon(x=xx,y=yy4,col=adjustcolor("yellow",0.5))
yy5=c(750,2100,2100,750);polygon(x=xx,y=yy5,col=adjustcolor("green",0.5))
abline(h=ymaj,v=xmaj,lty=3,col="grey")
abline(h=457,col="red")
with(cal.flow.dat.xtab,pt_line(Date,S79,2,"black",1,21,"grey",cex=1.25,pt.lwd=0.1))
with(cal.flow.dat.xtab,lines(Date,Q.14,lwd=3,col=adjustcolor("dodgerblue3",0.5)))
with(cal.flow.dat.xtab,lines(Date,Q.30,lwd=3,col=adjustcolor("black",0.5),lty=2))
axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d/%Y"),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj,cex.axis=1)
axis_fun(4,ymaj,ymin,format(round(cfs.to.acftd(ymaj)/1000,1)),cex.axis=1)

box(lwd=lwd.val)
mtext("Date\n(MM/DD/YYYY)",side=1,line=2.75,cex=1.25)
mtext("Discharge (cfs)",side=2,line=3.5,cex=1.25)
mtext("Discharge (kAc-Ft D\u207B\u00B9)",side=4,line=2.5,cex=1.25)

plot(0:1,0:1,type="n",yaxt="n",xaxt="n",bty="n")
legend(0.25,0.75,
       legend=c( "Damaging (>2600 cfs)","Stress (2100 - 2600 cfs)","Optimum (750 - 2100 cfs)"),pch=22,
       pt.bg=adjustcolor(c("red","yellow","green"),0.5),pt.cex=2,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5,title.adj = 0,title='RECOVER PM')

legend(0.75,0.75,
       legend=c("Daily Discharge","14-Day moving average","30-Day moving average","MFL (40E-8.221(2) FAC)"),
       pch=c(21,NA,NA,NA),pt.bg=c("grey",NA,NA,NA),pt.cex=c(1.5,NA,NA,NA),lty=c(NA,1,2,1),lwd=c(0.5,2,2,1),col=c("black",adjustcolor(c("dodgerblue1","black"),0.5),"red"),
       ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=1,xpd=NA,xjust=0.5,title.adj = 0,title='')

```

<font size=3><center>Daily, 14-day moving average and 30-day moving average discharge for S-79 relative to the Northern Estuaries RECOVER performance measure and the established minimium flows and levels (MFLs) for the recent 30-day period.</center></font>
<font size=4 color="red"><center>Data are provisional and subject to change.</center></font>

* As of `r format(YEST,"%b %d")`, discharges conditions are within the `r subset(cal.flow.dat.xtab,Date==YEST)$SalEnv.cat` RECOVER salinity envelope.

<br>

```{r CRE_cumQ, echo=FALSE,fig.width=7,fig.height=4,fig.align='center'}
ylim.max=signif(max(cal.flow.dat.xtab$cum.S79),0)
ylim.val=c(0,ylim.max);by.y=ylim.max/4;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
xlim.val=c(0,366);xmaj=seq(xlim.val[1],xlim.val[2],90);xmin=seq(xlim.val[1],xlim.val[2],30)
cols=c("indianred1","orange","dodgerblue1")

layout(matrix(1:2,1,2,byrow=F),widths = c(1,1,0.5))
par(family="serif",mar=c(2,2,1,1),oma=c(1,3,1,2));

plot(cum.S79~hydro.day,cal.flow.dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
for(i in 1:3){
if(i==3){
  with(subset(cal.flow.dat.xtab,WY==seq(CurWY-2,CurWY,1)[i]),lines(hydro.day,cum.S79,lwd=2.5,col=cols[i]))}else{
  with(subset(cal.flow.dat.xtab,WY==seq(CurWY-2,CurWY,1)[i]),lines(hydro.day,cum.S79,lwd=3,col=adjustcolor(cols[i],0.5)))}
 }
axis_fun(1,xmaj,xmin,xmaj,line=-0.5)
axis_fun(2,ymaj,ymin,ymaj/1000,cex.axis=1);box(lwd=lwd.val)
mtext("Day of Water Year",side=1,line=2,cex=1.25)
mtext("Cumulative Discharge (kAc-Ft D\u207B\u00B9)",side=2,line=3.5,cex=1.25)
mtext(side=3,"S-79",adj=0)

plot(cum.S79~hydro.day,cal.flow.dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
for(i in 1:3){
if(i==3){
  with(subset(cal.flow.dat.xtab,WY==seq(CurWY-2,CurWY,1)[i]),lines(hydro.day,cum.S77,lwd=2.5,col=cols[i]))}else{
  with(subset(cal.flow.dat.xtab,WY==seq(CurWY-2,CurWY,1)[i]),lines(hydro.day,cum.S77,lwd=3,col=adjustcolor(cols[i],0.5)))}
 }
axis_fun(1,xmaj,xmin,xmaj,line=-0.5)
axis_fun(2,ymaj,ymin,NA);box(lwd=lwd.val)
mtext("Day of Water Year",side=1,line=2,cex=1.25)
mtext(side=3,"S-77",adj=0)

#plot(0:1,0:1,type="n",yaxt="n",xaxt="n",bty="n")
legend("topright",
       legend=c(paste0("WY",seq(CurWY-2,CurWY,1))),
       col=cols,lty=c(1),lwd=c(2.5),pt.cex=1,ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.5,xpd=NA,xjust=0.5)

```

<font size=3><center>Cumulative discharge for S-79 (to Tidal Basin) and S-77 (from Lake Okeechobee) for the last three Florida Water Years (May - April). Day of water year is analogous to day of year with Day 1 = May 1<sup>st</sup>.</center></font>
<font size=4 color="red"><center>Data are provisional and subject to change.</center></font>

### Chlorophyll, Phycocyanin & fDOM

```{r S79_fdom,echo=FALSE,fig.width=6.5,fig.height=5,fig.align='center'}
# 32315 relative fChl
# 32321 relative Phycocyanin
#cal.algae=readNWISdv("02292900",c("32315","32321"),"2017-11-01",format(End.Date,"%Y-%m-%d"))
cal.algae=readNWISdv("02292900",c("00300","32295","32315","32321"),format(Start.Date,"%Y-%m-%d"),format(End.Date,"%Y-%m-%d"))
cal.algae=renameNWISColumns(cal.algae)
cal.algae$Date=date.fun(cal.algae$Date)

cal.algae=merge(cal.algae,data.frame(Date=date.fun(seq(Start.Date,End.Date,"1 days")),fill=1),"Date",all.y=T)

cal.algae$phy_chl=with(cal.algae,X_FLOATING_32321/(X_FLOATING_32321+X_FLOATING_32315))

EDate.plot=as.Date(Sys.time())+duration(1,"days")
SDate.plot=as.Date(EDate.plot-duration(14,"days"))
lwd.val=1
xlim.val=as.POSIXct(strptime(c(SDate.plot,EDate.plot),"%Y-%m-%d"),tz="EST")
xmaj=seq(xlim.val[1],xlim.val[2],by="7 days");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")

min.CDOM=min(subset(cal.algae,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$X_FLOATING_32295,na.rm=T)
ylim.min=if(min.CDOM>300){200}else{100}
max.CDOM=max(subset(cal.algae,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$X_FLOATING_32295,na.rm=T)
ylim.max=round(max.CDOM+max.CDOM*0.25,-2)
ylim.val=c(ylim.min,ylim.max);

by.y=100
ymaj=seq(ylim.val[1],ylim.val[2],by.y);
ymin=seq(ylim.val[1],ylim.val[2],by.y/2)

par(family="serif",mar=c(1,3,0.5,4),oma=c(3,3,2.5,2));
layout(matrix(1:3,3,1),heights=c(1,1,0.5))

plot(X_FLOATING_32295~Date,cal.algae,ylim=ylim.val,xlim=xlim.val,type="n",axes=F,ann=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(cal.algae,pt_line(Date,X_FLOATING_32295,2,"tan3",1.5,21,"tan3",cex=1.5,pt.lwd=0.1))
axis_fun(2,ymaj,ymin,format(ymaj))
axis_fun(1,xmaj,xmin,NA);box(lwd=1)
mtext(side=2,line=2.5,"fDOM (RFU)")
mtext(side=3,adj=0,"S-79 - Floating Sensor\n(USGS Site: 02292900)")
mtext(side=3,adj=1,"Data are provisional",col="red")

ylim.val=c(0,12);
by.y=max(ylim.val)/3;
ymaj=seq(ylim.val[1],ylim.val[2],by.y);
ymin=seq(ylim.val[1],ylim.val[2],by.y/2)

ylim.val2=c(0,6);
by.y2=max(ylim.val2)/3;
ymaj2=round(seq(ylim.val2[1],ylim.val2[2],by.y2),1);
ymin2=round(seq(ylim.val2[1],ylim.val2[2],by.y2/2),1)

plot(X_FLOATING_32315~Date,cal.algae,ylim=ylim.val,xlim=xlim.val,type="n",axes=F,ann=F)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(cal.algae,pt_line(Date,X_FLOATING_32315,1,"forestgreen",1.5,21,"forestgreen",cex=1.5,pt.lwd=0.1))
with(cal.algae,pt_line(Date,X_FLOATING_32321,1,"dodgerblue1",1.5,21,"dodgerblue1",cex=1.5,pt.lwd=0.1))
axis_fun(2,ymaj,ymin,format(ymaj))
abline(h=3.8,lty=2,col="red");# based ib fChl and grab Chl-a model (fChlAnalysis_summary.rmd). 

axis_fun(1,xmaj,xmin,NA);box(lwd=1)
mtext(side=2,line=2.5,"Relative Fluorescence\nUnits (RFU) ")
legend("topleft",legend=c("Chlorophyll","Phycocyanin","~20 \u03BCg L\u207B\u00B9 Chl-a"),
       lty=c(1,1,2),lwd=3,col=c("forestgreen","dodgerblue1","red"),
       ncol=1,cex=1,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5)
ylim.val3=c(0,1);
by.y3=0.5;
ymaj3=seq(ylim.val3[1],ylim.val3[2],by.y3);
ymin3=seq(ylim.val3[1],ylim.val3[2],by.y3/2)

plot(phy_chl~Date,cal.algae,ylim=ylim.val3,xlim=xlim.val,type="n",axes=F,ann=F)
abline(h=ymaj3,v=xmaj,lty=3,col="grey")
with(cal.algae,pt_line(Date,phy_chl,1,"indianred1",1.5,21,"indianred1",cex=1.5,pt.lwd=0.1))
axis_fun(2,ymaj3,ymin3,format(ymaj3))
axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d/%Y"));box(lwd=1)
mtext(side=2,line=2.5,expression(paste(frac("Phyco","Phyco + Chl"))))
mtext("Date (MM/DD/YYYY)",side=1,line=2.25,cex=1)


```

<font size=3><center>Top: Daily dissolved organic matter (fluorescence DOM). Middle: Daily relative fluorescence Chlorophyll and Phycocyanin observed at the floating sensor bouy at S-79 monitoring by USGS. Bottom: The relative ratio of Phycocyanin (Phyco) relative to Phyco and Chlorophyll (Chl). </center></font>
<font size=4 color="red"><center>Data are provisional and subject to change.</center></font>

### Estuary Salinity 
```{r Caloosa Data, include=FALSE}
End.Date=as.Date(Sys.time()); ## Update this value
Start.Date=as.Date(End.Date-duration(30,"days"));

bk.dbkeys.bot=data.frame(depth="bottom",
                         SITE=c(rep("VALI75",2),rep("FORTMYERSM",2),rep("CCORAL",2),rep("MARKH",2),rep("SANIB2",2)),
                         param=rep(c("WT","SPC"),5),
                         DBKEY=c("UL030","UL026","88288","88291","UO832","AJ012","88198","88202","WN375","WN377")
                         )
sal.dat=data.frame()
for(i in 1:nrow(bk.dbkeys.bot)){
  tmp=DBHYDRO_breakpoint(Start.Date,End.Date,bk.dbkeys.bot$DBKEY[i])
  tmp$DBKEY=bk.dbkeys.bot$DBKEY[i]
  sal.dat=rbind(sal.dat,tmp)
  print(i)
}
sal.dat=merge(sal.dat,bk.dbkeys.bot,"DBKEY")
sal.dat$Date.EST=date.fun(sal.dat$DATETIME)
sal.dat$Data.Value[sal.dat$Data.Value==-999]<-NA
sal.dat$Data.Value[sal.dat$param=="SPC"&sal.dat$Data.Value<300]<-NA
#subset(sal.dat,Data.Value<0)
da.screen=ddply(sal.dat,c("Date.EST","SITE"),summarise,N.val=N.obs(Data.Value[param=="SPC"]))
da.screen$screen=with(da.screen,ifelse(N.val<20,0,1))

sal.dat.xtab=data.frame(cast(sal.dat,SITE+Date.EST~param,value="Data.Value",fun.aggregate = function(x)mean(x,na.rm=T)))
fill=data.frame(expand.grid(SITE=unique(bk.dbkeys.bot$SITE),Date.EST=date.fun(seq(Start.Date,End.Date,"1 days"))))
sal.dat.xtab=merge(sal.dat.xtab,fill,c("SITE","Date.EST"),all.y=T)
sal.dat.xtab$Sal=with(sal.dat.xtab,SalinityCalc(SPC,WT))
Cal.Sal=subset(sal.dat.xtab,SITE%in%c("CCORAL","FORTMYERSM","MARKH","SANIB2"))
unique(Cal.Sal$SITE)

Cal.Sal=merge(Cal.Sal,da.screen,c("Date.EST","SITE"))
Cal.Sal$Sal=with(Cal.Sal,ifelse(screen==1,Sal,NA))
Cal.Sal$MovingAvg.7d=with(Cal.Sal,ave(Sal,SITE,FUN=function(x) roll_meanr(x,n=7)))

# subset(sal.dat,SITE==CALSITES[2])
# subset(da.screen,SITE==CALSITES[2])
# subset(Cal.Sal,SITE==CALSITES[2])
# test.chk=cast(subset(sal.dat,
#                      Date.EST%in%seq(date.fun("2022-03-12"),date.fun("2022-03-14"),"1 days")),
#               SITE+DATETIME+Date.EST~param,value="Data.Value",fun.aggregate = function(x)mean(x,na.rm=T))
# test.chk$Sal=with(test.chk,SalinityCalc(SPC,WT))
# 
# par(family="serif",cex.axis=1.2,mar=c(1.5,2,1,1),oma=c(2,3,4,1),mgp=c(3,1,0));
# layout(matrix(c(1:4,rep(5,3),6),2,4,byrow=T),heights=c(1,0.25));
# xlim.val=as.POSIXct(strptime(c("2022-03-12","2022-03-14"),"%Y-%m-%d"),tz="EST")
# for(i in 1:4){
# plot(Sal~DATETIME,subset(test.chk,SITE==CALSITES[i]),type="n",ylim=c(0,40),xlim=xlim.val,xaxs="i",yaxs="i",ann=F,axes=F)
# abline(h=seq(0,40,5))
# with(subset(test.chk,SITE==CALSITES[i]),pt_line(DATETIME,Sal,1,colrmp,2,21,colrmp,cex=2,pt.col=colrmp))
# axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d"),line=-0.5)
# axis_fun(2,ymaj,ymin,ymaj)
# mtext(side=3,station.label[i])
# box(lwd=lwd.val)
# }

## recon data
recon.dat.fun

recon.dat=data.frame()
recon.site.val=c(53,13,11)
for(i in 1:3){
  tmp=recon.dat.fun(Start.Date,End.Date,c('conductivity','temperature'),recon.site.val[i])
  recon.dat=rbind(recon.dat,tmp)
}
recon.dat$sal=with(recon.dat,SalinityCalc(conductivity*10000,temperature))
plot(recon.dat$sal)

fill=data.frame(expand.grid(SiteID=unique(recon.dat$SiteID),Date.EST=date.fun(seq(Start.Date,End.Date,"1 days"))))
recon.dat=merge(recon.dat,fill,c("SiteID","Date.EST"),all.y=T)
recon.dat$MovingAvg.7d=with(recon.dat,ave(sal,SiteID,FUN=function(x) roll_meanr(x,n=7)))

```

```{r CRE_Sal,echo=FALSE,fig.width=10,fig.height=5,fig.align='center'}
CALSITES=c("SANIB2","MARKH","CCORAL","FORTMYERSM","S79")
recon.sites=c(11,13,NA,53)
EDate.plot=as.Date(Sys.time())+duration(1,"days")
SDate.plot=as.Date(EDate.plot-duration(15,"days"))
lwd.val=1
xlim.val=as.POSIXct(strptime(c(SDate.plot,EDate.plot),"%Y-%m-%d"),tz="EST")
xmaj=seq(xlim.val[1],xlim.val[2],by="7 days");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")

ylim.val=c(0,40);
ylim.val2=c(0,20);
by.y=10;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
colrmp="blue"
txt.cex=1

# png(filename=paste0(plot.path,"Cal_Sal.png"),width=10,height=5,units="in",res=200,type="windows",bg="white")
par(family="serif",cex.axis=1.2,mar=c(1.5,2,1,1),oma=c(2,3,4,1),mgp=c(3,1,0));
layout(matrix(c(1:4,rep(5,3),6),2,4,byrow=T),heights=c(1,0.25));

station.label=c("Sanibel","Shell Point","Cape Coral","Ft. Myers")
recon.lab=c("Tarpon Bay","Shell Point",NA,"Ft. Myers")
for(i in 1:3){
plot(Sal~Date.EST,subset(Cal.Sal,SITE==CALSITES[i]),type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",ann=F,axes=F)
xx=c(xlim.val[1],xlim.val[1],xlim.val[2],xlim.val[2])
yy=c(0,5,5,0);polygon(x=xx,y=yy,col="peachpuff1")
yy2=c(35,40,40,35);polygon(x=xx,y=yy2,col="peachpuff1")
yy3=c(30,35,35,30);polygon(x=xx,y=yy3,col="khaki")
yy4=c(5,10,10,5);polygon(x=xx,y=yy4,col="khaki")
yy5=c(10,30,30,10);polygon(x=xx,y=yy5,col="darkseagreen2")
abline(h=seq(0,40,5))
with(subset(Cal.Sal,SITE==CALSITES[i]),pt_line(Date.EST,Sal,1,colrmp,2,21,colrmp,cex=2,pt.col=colrmp))
with(subset(Cal.Sal,SITE==CALSITES[i]),lines(Date.EST,MovingAvg.7d,lwd=2.5,col="orange"))

if(i<3){
with(subset(recon.dat,SiteID==recon.sites[i]),pt_line(Date.EST,sal,1,"grey50",1,22,"grey50",cex=1.5,pt.col="black"))
with(subset(recon.dat,SiteID==recon.sites[i]),lines(Date.EST,MovingAvg.7d,lty=2,lwd=1.5,col="orange"))
legend("topleft",legend=c(paste0(station.label[i]," - SFWMD"),"SFWMD Moving Avg",
                          paste0(recon.lab[i]," - SCCF"),"SCCF Moving Avg"),
       lty=c(NA,1,NA,2),lwd=c(0.1,1,0.1,1),col=c(colrmp,"orange","black","orange"),
       pch=c(21,NA,22,NA),pt.bg=c(colrmp,NA,"grey50",NA),
       pt.cex=1,ncol=2,cex=0.8,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0)
}else{
  legend("topleft",legend=c(paste0(station.label[i]," - SFWMD"),"SFWMD Moving Avg"),
       lty=c(NA,1),lwd=c(0.1,1),col=c(colrmp,"orange"),
       pch=c(21,NA),pt.bg=c(colrmp,"grey50"),
       pt.cex=1,ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0)
}
axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d"),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj)
mtext(side=3,station.label[i])
box(lwd=lwd.val)
if(i==1){mtext(side=2,"Salinity (PSU)",line=2,cex=1.25)}
if(i==2){mtext(expression(paste(underline("Oyster Condition"))),side=3,cex=1,line=1.75,outer=F)}
}

plot(Sal~Date.EST,subset(Cal.Sal,SITE==CALSITES[i]),type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",ann=F,axes=F)
xx=c(xlim.val[1],xlim.val[1],xlim.val[2],xlim.val[2])
yy=c(0,10,10,0);polygon(x=xx,y=yy,col="darkseagreen2")
yy=c(10,15,15,10);polygon(x=xx,y=yy,col="khaki")
yy=c(15,40,40,15);polygon(x=xx,y=yy,col="peachpuff1")
abline(h=seq(0,40,5))
with(subset(Cal.Sal,SITE==CALSITES[4]),pt_line(Date.EST,Sal,1,colrmp,2,21,colrmp,cex=2,pt.col=colrmp))
with(subset(Cal.Sal,SITE==CALSITES[4]),lines(Date.EST,MovingAvg.7d,lwd=2.5,col="orange"))
with(subset(recon.dat,SiteID==recon.sites[4]),pt_line(Date.EST,sal,1,"grey50",2,22,"grey50",cex=1,pt.col="black"))
with(subset(recon.dat,SiteID==recon.sites[4]),lines(Date.EST,MovingAvg.7d,lty=2,lwd=1.5,col="orange"))
legend("topleft",legend=c(paste0(station.label[4]," - SFWMD"),"SFWMD Moving Avg",
                          paste0(recon.lab[4]," - SCCF"),"SCCF Moving Avg"),
       lty=c(NA,1,NA,2),lwd=c(0.1,1,0.1,1),col=c(colrmp,"orange","black","orange"),
       pch=c(21,NA,22,NA),pt.bg=c(colrmp,NA,"grey50",NA),
       pt.cex=1,ncol=2,cex=0.8,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0)

axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d"),line=-0.5)
axis_fun(2,ymaj,ymin,ymaj)
mtext(side=3,station.label[4])
box(lwd=lwd.val)
mtext("Month/Day",side=1,line=-6,cex=1.25,outer=T)
mtext(expression(paste(underline("Tape grass Condition"))),side=3,cex=1,line=1.75,outer=F)

plot(0:1,0:1,ann=F,axes=F,type="n")
legend(0.25,0.15,legend=c("Daily Average", "7-Day Moving Avg"),
       pch=c(21,NA),
       lty=c(NA,1),
       lwd=c(0.01,3),
       col=c("blue","orange"),
       pt.bg=c("blue",NA),
       pt.cex=1.5,ncol=1,cex=1.25,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0.5,
       title.adj = 0,title="")
legend(0.5,0.15,legend=c("Poor(<5 or >35)","Fair (5-10 or 30-35)","Good(10-30)"),
       pch=c(22,22,22),
       lty=NA,
       lwd=0.01,
       col="black",
       pt.bg=c("peachpuff1","khaki","darkseagreen2"),
       pt.cex=2.5,ncol=1,cex=1.25,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0.5,
       title.adj = 0,title="Oyster Salinity Condition")

plot(0:1,0:1,ann=F,axes=F,type="n")
legend(0.5,0.15,legend=c("Poor(>15)","Fair (10 - 15)","Good(<10)"),
       pch=c(22,22,22),
       lty=NA,
       lwd=0.01,
       col="black",
       pt.bg=c("peachpuff1","khaki","darkseagreen2"),
       pt.cex=2.5,ncol=1,cex=1.25,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=0.5,
       title.adj = 0,title="Tape Grass Salinity Condition")
grid.raster(logo,x=0.045,y=0.055,just=c("left","bottom"),width=unit(1.25,"inches"))
# dev.off()
```


<font size=2><center>Daily average bottom salinity data for the last 14-days from sampling locations within the tidal Caloosahatchee River Estuary relative to oyster health (Sanibel, Shell Point and Cape Coral) and tape grass (<i>Vallisneria americana</i>) health (Ft. Myers only) conditions.</center></font>
<font size=3 color="red"><center>Data are provisional and subject to change.</center></font>


### Red Tide Abundance
<br>
```{r red tide,echo=F,include=F}

HABext=extent(-82.5,
              -80.0,
              24.4,
              27.4)
# HABext=extent(-83.1,
#               -80.0,
#               24.4,
#               28.1)
HABext.poly=as(HABext,"SpatialPolygons")
proj4string(HABext.poly)=wgs84
HABext.poly=SpatialPolygonsDataFrame(HABext.poly,data.frame(ID="HAB"))
# tm_shape(HABext.poly)+tm_polygons(alpha=0.5)
HABext2=extent(HABext)

CRE.ext=extent(-82.3,
              -81.8,
              26.3,
              26.7)
CRE.ext=as(CRE.ext,"SpatialPolygons")
proj4string(CRE.ext)=wgs84
CRE.ext=SpatialPolygonsDataFrame(CRE.ext,data.frame(ID="CRE"))
# tm_shape(CRE.ext)+tm_polygons(alpha=0.5)

TBEP.ext=extent(-83.4,
                -82.08,
                27.0,
                28.2)
TBEP.ext.poly=as(TBEP.ext,"SpatialPolygons")
proj4string(TBEP.ext.poly)=wgs84

kbr.AOI=extent(bind(HABext.poly,TBEP.ext.poly))
kbr.AOI=as(kbr.AOI,"SpatialPolygons")
# Red Tide ----------------------------------------------------------------
## south of Tampa Bay 
## Based on https://github.com/tbep-tech/piney-point/blob/141824adc082a57d79ba58ff38ac31d41dea4e44/R/dat_proc.R#L1262
path <- 'https://gis.ncdc.noaa.gov/arcgis/rest/services/ms/HABSOS_CellCounts/MapServer/0/query?'

request <- GET(
  url = path,
  query= list(
    where= paste("LATITUDE <",round(HABext2[4],1),"AND LATITUDE >",round(HABext2[3],1),"AND LONGITUDE >",round(HABext2[1],1),"AND LONGITUDE <",round(HABext2[2],1)),
    outFields = 'DESCRIPTION,SAMPLE_DATE,SAMPLE_DEPTH,LATITUDE,LONGITUDE,SALINITY,SALINITY_UNIT,WATER_TEMP,WATER_TEMP_UNIT,GENUS,SPECIES,CATEGORY,CELLCOUNT,CELLCOUNT_UNIT',
    f = 'pjson'
  )
)


response <- content(request, as = "text", encoding = "UTF-8")
results <- jsonlite::fromJSON(response,flatten=T)
# results
kbrdat=results$features
if(is.null(kbrdat)==F){
# kbrdat

# Tampa Bay Results
# request <- GET(
#   url = path,
#   query= list(
#     where= paste("LATITUDE <",round(TBEP.ext[4],1),"AND LATITUDE >",round(TBEP.ext[3],1),"AND LONGITUDE >",round(TBEP.ext[1],1),"AND LONGITUDE <",round(TBEP.ext[2],1)),
#     outFields = 'DESCRIPTION,SAMPLE_DATE,SAMPLE_DEPTH,LATITUDE,LONGITUDE,SALINITY,SALINITY_UNIT,WATER_TEMP,WATER_TEMP_UNIT,GENUS,SPECIES,CATEGORY,CELLCOUNT,CELLCOUNT_UNIT',
#     f = 'pjson'
#   )
# )
#
# response <- content(request, as = "text", encoding = "UTF-8")
# # if(strsplit(response,"<title>|</title>")[[1]][2]=="503 Service Unavailable"){results=NA}else{
# results <- jsonlite::fromJSON(response,flatten=T)
# # results
#
# kbrdat=rbind(kbrdat,results$features)
# kbrdat=kbrdat[duplicated(kbrdat)==F,]

vars=c("attributes.DESCRIPTION","attributes.SAMPLE_DATE",
       "attributes.SAMPLE_DEPTH","attributes.LATITUDE",
       "attributes.LONGITUDE", "attributes.SALINITY", "attributes.SALINITY_UNIT",
       "attributes.WATER_TEMP", "attributes.WATER_TEMP_UNIT", "attributes.GENUS",
       "attributes.SPECIES", "attributes.CATEGORY", "attributes.CELLCOUNT",
       "attributes.CELLCOUNT_UNIT", "geometry.x", "geometry.y")
vars=strsplit(vars,"\\.")
vars=sapply(vars,"[",2)

colnames(kbrdat)<-tolower(vars)

kbrdat$date=as.POSIXct(as.numeric(gsub('000$', '',format(kbrdat$sample_date,scientific=F))),
                         origin = c('1970-01-01'), tz = 'UTC')
kbrdat$datetime=date.fun(kbrdat$date,form="%F %R")
kbrdat$date=date.fun(kbrdat$date)
kbrdat$year=as.numeric(format(kbrdat$date,"%Y"))
# range(kbrdat$year,na.rm=T)
kbrdat=subset(kbrdat,is.na(year)==T|year!=153)
# min(kbrdat$date)
# max(kbrdat$date)
##
cat.abund.xwalk=data.frame(category=c("not observed","very low","low","medium","high"),
                           abund=c("not present/background (0-1,000)", "very low (>1,000-10,000)",
                                   "low (>10,000-100,000)", "medium (>100,000-1,000,000)",
                                   "high (>1,000,000)"))

kbrdat=merge(kbrdat,cat.abund.xwalk,"category")
kbrdat$Abundance=factor(kbrdat$abund,levels=cat.abund.xwalk$abund)
kbrdat$category=factor(kbrdat$category,levels=cat.abund.xwalk$category)

kbrdat.shp=SpatialPointsDataFrame(coords=kbrdat[,c("longitude","latitude")],
                                          data=kbrdat,
                                          proj4string = wgs84)


kbrdat_30d=subset(kbrdat,date<=TODAY&date>=sdate.algae)
kbrdat_30d.shp=SpatialPointsDataFrame(coords=kbrdat_30d[,c("longitude","latitude")],
                                          data=kbrdat_30d,
                                          proj4string = wgs84)

}

```


```{r,fig.width=7,fig.height=6,fig.align='center',fig.cap="Red tide sampling results for the last 30-days from just south of Tampa Bay to the Florida Keys. Data from NOAA HABSOS Program.Data are provisional and subject to change."}
par(family="serif",oma=c(0.25,0.25,0.25,0.25),mar=c(0.1,0.1,0.1,0.1),xpd=F)
# layout(matrix(c(1:2),1,2,byrow=T),widths = c(1,0.3))
# par(family="serif",mar=c(0.1,0.1,0.1,0.1),oma=c(0.5,0.5,0.5,0.5));
layout(matrix(1:2,1,2,byrow=F),widths=c(1,0.5))
# bbox.lims=bbox(bind(HABext.poly,TBEP.ext.poly))
bbox.lims=bbox(HABext.poly)

if(is.null(kbrdat)==T){
  plot(shore,col="cornsilk",border="grey",bg="lightblue",ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=0.01)
  text(gCentroid(HABext.poly),"No data available\nat this time\n(data server issues)",col="red",cex=3)
  plot(0:1,0:1,ann=F,axes=F,type="n")
  }else{

plot(shore,col="cornsilk",border="grey",bg="lightblue",ylim=bbox.lims[c(2,4)],xlim=bbox.lims[c(1,3)],lwd=0.01)
abund.cols=c("white","grey","dodgerblue1","orange","indianred1")
plot(kbrdat_30d.shp,add=T,pch=21,lwd=0.01,
     bg=abund.cols[kbrdat_30d.shp$Abundance])
# plot(TBEP.ext.poly,add=T,border="black",lty=2,col=NA)
plot(HABext.poly,add=T,border="grey",lty=2,col=NA)
plot(CRE.ext,add=T,border="red",lwd=2)
box(lwd=1)
mapmisc::scaleBar(wgs84,"bottomleft",bty="n",cex=1,seg.len=4,outer=F)

plot(0:1,0:1,ann=F,axes=F,type="n")
date.rng=range(kbrdat_30d.shp$date,na.rm=T)
legend("center",legend=c(cat.abund.xwalk$abund,"Caloosahatchee River Estuary"),
       pch=c(rep(21,length(cat.abund.xwalk$abund)),22),lty=c(NA),
             lwd=c(rep(0.01,length(cat.abund.xwalk$abund)),2),
       col=c(rep("black",length(cat.abund.xwalk$abund)),"red"),
       pt.bg=c(abund.cols,NA),
       pt.cex=2,ncol=1,cex=0.8,bty="n",y.intersp=1,x.intersp=0.75,xpd=NA,xjust=0.5,yjust=1.25,
       title.adj = 0,title=paste0("Red Tide Abundance\n",format(date.rng[1],"%b %d,%Y")," to ",format(date.rng[2],"%b %d,%Y"),""))
  }

```



```{r,out.width='100%'}
# if(is.na(kbrdat)==F){
#   tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
# tm_shape(kbrdat_30d.shp)+tm_dots(col="Abundance",
#                                  palette =c("white","grey","dodgerblue1","orange","indianred1"),
#                                  size=0.03,
#                                  id="date",
#                                  popup.vars=c("date","cellcount","cellcount_unit"
#                                               ,"category","genus","species",
#                                               "sample_depth"),
#                                  group="NOAA/FWC Redtide Data")+
#   tm_shape(CRE.ext)+tm_borders(group="Greater Caloosahatchee Estuary",col="white",lwd=2)+
#   tm_shape(HABext.poly)+tm_borders(group="Area of Interest - South Florida",lwd=1,lty="dashed",col="grey")+
#   tm_shape(TBEP.ext.poly)+tm_borders(group="Area of Interest- Tampa Bay Area",lwd=1,lty="dashed",col="grey")
#   # tm_shape(kbr.AOI)+tm_borders(group="Area of Interest",lwd=1,lty="dashed",col="grey")
# }else{
# tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
#   tm_shape(HABext.poly)+tm_borders(group="Area of Interest - South Florida",lwd=1,lty="dashed",col="grey")+
#   tm_shape(TBEP.ext.poly)+tm_borders(group="Area of Interest- Tampa Bay Area",lwd=1,lty="dashed",col="grey")
#   # tm_shape(kbr.AOI)+tm_borders(group="Area of Interest",lwd=1,lty="dashed",col="grey")
# }
```

<font size=2><center>Red tide sampling results for the last 30-days from just south of Tampa Bay to the Florida Keys. Data from NOAA HABSOS Program</center></font><font size=3 color="red"><center>Data are provisional and subject to change.</center></font>


```{r}
rslt =plyr::ddply(kbrdat_30d.shp[CRE.ext,]@data,"category",summarise,N.val=N.obs(category))

rslt=merge(cat.abund.xwalk,rslt,"category",all.x=T)

rslt=rslt[match(cat.abund.xwalk$abund,rslt$abund),]

cap.val="Count of samples within each abundance category within the greater Caloosahatchee River Estuary (see grey box on map)"
rslt[,c("abund","N.val")]%>%
  flextable()%>%
  colformat_num(j=2,big.mark = "",digits=0,na_str = "---")%>%
  set_header_labels("abund"="Cell Abundance (Cells L\u207B\u00B9)",
                    "N.val"="Number\nof\nSamples")%>%
  align(j=2,align="center",part="all")%>%
  width(width=c(2.5,0.5))%>%
  padding(padding=2,part="all")%>%
  fontsize(size=10,part="body")%>%
  fontsize(size=12,part="header")%>%
  add_header_lines(values=cap.val)%>%
  align(align="center",part="header")%>%fontsize(size=12,part="header")%>%font(fontname = "Times New Roman",part="all")

```

<br>

```{r,echo=F}

noaa.HAB=readLines("https://products.coastalscience.noaa.gov/habs_explorer/index.php?path=ajZiOVoxaHZNdE5nNytEb3RZdU5iWkFHMyttU2kvbDlVMVZtQkM1T1RSZz0=")

vals=grep("<section class='onecol habonecol'><a href='https://products.coastalscience.noaa.gov/habs_explorer/index.ph",noaa.HAB)
# vals=grep("truecolor_rbd_rhos.swfl",noaa.HAB)

noaa.image.inventory=data.frame()
# for(i in 1:3){
for(i in 1:length(vals)){
  if(nchar(noaa.HAB[vals[i]])<2000){
    tmp=noaa.HAB[vals[i]]
    tmp2=strsplit(tmp,"<a|</a>")[[1]][2]
    fname1=strsplit(tmp,"<a|</a>")[[1]][3]
    
    tmp3=strsplit(tmp2,"href=|title=|>")
  
    dat=data.frame(fileadd=sapply(tmp3,"[",2),filename=strsplit(fname1,"</")[[1]][1])
    
    }else{
  tmp=noaa.HAB[vals[i]]
  tmp2=strsplit(tmp,"<a|</a>")[[1]][4]
  tmp3=strsplit(tmp2,"href=|title=|>")
  
  dat=data.frame(fileadd=sapply(tmp3,"[",2),filename=sapply(tmp3,"[",3))
    }
  fname.vals=strsplit(dat$filename,"_")
  # dat$data.product=sapply(fname.vals,"[",length(fname.vals[[1]]))
  
  dat$data.product=substr(dat$filename,51,100)
  
  date.vals=strsplit(sapply(fname.vals,"[",1),"\\.")
  yr.val=as.numeric(substr(sapply(date.vals,"[",2),1,4))
  month.val=as.numeric(substr(sapply(date.vals,"[",3),1,2))
  day.val=as.numeric(substr(sapply(date.vals,"[",3),3,4))
  dat$date=as.Date(paste(yr.val,month.val,day.val,sep="-"))
  
  noaa.image.inventory=rbind(dat,noaa.image.inventory)
  
  
}

# noaa.HAB.image=subset(noaa.image.inventory,data.product=="1_2.truecolor_rbd_rhos.swfl.png'"&date==max(noaa.image.inventory$date))
noaa.HAB.image=subset(noaa.image.inventory,date==max(noaa.image.inventory$date))
noaa.HAB.image$data.product=substr(noaa.HAB.image$data.product,nchar(noaa.HAB.image$data.product)-27,nchar(noaa.HAB.image$data.product)-1)
noaa.HAB.image=subset(noaa.HAB.image,data.product=="truecolor_rbd_rhos.swfl.png")

```

```{r, out.width="90%",echo=FALSE,fig.align="center",fig.cap=paste("Chlorophyll fluorescence for coastal southwest Florida for",noaa.HAB.image$date,"(Data Source: NOAA NCCOS)")}
knitr::include_graphics(noquote(gsub("'",'',noaa.HAB.image$fileadd)))
```

```{r, out.width="50%",echo=FALSE,fig.align="center"}
knitr::include_graphics("https://nccospublicstor.blob.core.windows.net/hab-data/data/web/olci_fl_swfl/legend.png")
```

### Red Tide Forecast

Red Tide Prediction and Tracking for coastal Southwest Florida from FWC and USF [link](http://ocgweb.marine.usf.edu/hab_tracking/wfcom_hab.html){target="_blank"}.

```{r out.width=c('50%', '50%'), fig.show='hold',fig.cap="Upper and lower water column HAB (Red Tide) forecasted trajectories from Ocean Circulation Group at USF.",fig.align="center"}
# https://holtzy.github.io/Pimp-my-rmd/
knitr::include_graphics("http://ocgweb.marine.usf.edu/hab_tracking/upper_water_column_R4.png")
knitr::include_graphics("http://ocgweb.marine.usf.edu/hab_tracking/lower_water_column_R4.png")
```


```{r, out.width="50%",echo=FALSE,fig.align="center",fig.cap="Statewide Gulf of Mexico coastal Red Tide forecast from FWC and USF.",fig.align="center"}
knitr::include_graphics("http://ocgweb.marine.usf.edu/hab_tracking/hab_fcst.jpeg")
```

***

## Charlotte Harbor

### Discharge

```{r,echo=F}
charhar.sites=data.frame(SITE=c("02298202","02296750","02298880","02297100","02299472"),
                         SiteName.abbr=c("Shell","Peace","Myakka","Joshua","BigSlough"),
                         Site.Lab=c("Shell Creek","Peace River","Myakka River","Joshua Creek","Big Slough"))
charhar.sites=charhar.sites[match(c("Myakka","BigSlough","Peace","Joshua","Shell"),charhar.sites$SiteName.abbr),]

q.dat=readNWISdv(charhar.sites$SITE,c("00060"),format(Start.Date,"%Y-%m-%d"),format(End.Date,"%Y-%m-%d"))
q.dat=renameNWISColumns(q.dat)
q.dat$Date=date.fun(q.dat$Date)
q.dat=merge(q.dat,charhar.sites,by.x="site_no",by.y="SITE")
q.dat$Flow.acft=cfs.to.acftd(q.dat$Flow)

# tail(subset(q.dat,site_no=="02296750"))
fill=expand.grid(Date=seq(date.fun(Start.Date),max(q.dat$Date),"1 days"),
                 SITE=charhar.sites$SITE)
fill=merge(fill,charhar.sites,"SITE")
q.dat=merge(q.dat,fill,by.x=c("site_no","Date","SiteName.abbr"),by.y=c("SITE","Date","SiteName.abbr"),all.y=T)

q.dat$flow.fill=with(q.dat,ave(Flow.acft,site_no,FUN=function(x) zoo::na.approx(x)))
q.dat$Q.7d=with(q.dat,ave(flow.fill,SiteName.abbr,FUN=function(x) roll_meanr(x,n=7)))
q.dat$N.Q.7d=with(q.dat,ave(Flow.acft,SiteName.abbr,FUN=function(x) rollapply(x,width=7,fill=NA,align="right",FUN=function(x)N.obs(x))))
# range(q.dat$Flow)
#q.dat.xtab=cast(q.dat,Date~SiteName.abbr,value="Flow",fun.aggregate=function(x) sum(cfs.to.acftd(x),na.rm=T))
# q.dat.xtab=cast(q.dat,Date~SiteName.abbr,value="Flow",sum,na.rm=T)
q.dat.xtab=cast(q.dat,Date~SiteName.abbr,value="flow.fill",sum, na.rm=T)
charhar.sites2=readNWISsite(charhar.sites$SITE)
q.dat.xtab$Tflow=rowSums(q.dat.xtab[,2:ncol(q.dat.xtab)])


NWIS.siteinfo=readNWISsite(charhar.sites$SITE)
NWIS.siteinfo.shp=SpatialPointsDataFrame(coords=NWIS.siteinfo[,c("dec_long_va","dec_lat_va")],
                                          data=NWIS.siteinfo,
                                          proj4string = wgs84)







```


```{r,out.width='100%'}
# tm_basemap(leaflet::providers$Esri.WorldImagery,alpha=0.9)+
#   tm_shape(NWIS.siteinfo.shp)+tm_dots(col="red",
#                                  size=0.05,
#                                  id="site_no",
#                                  popup.vars=c("agency_cd","site_no","station_nm"
#                                               ,"huc_cd","drain_area_va"),
#                                  group="USGS Sites")
#   
```

<!-- <font size=2><center>USGS discharge monitoring locations for rivers and creeks entering Charlotte Harbor</center></font> -->

```{r CharHar_Q,echo=FALSE,fig.width=5,fig.height=6,fig.align='center'}

xlim.val=date.fun(c(TODAY-ddays(30),TODAY+ddays(3)));xmaj=seq(xlim.val[1],xlim.val[2],by="7 days");xmin=seq(xlim.val[1],xlim.val[2],by="1 days")
cols=c("#3B9AB2", "#78B7C5", "#EBCC2A", "#E1AF00", "#F21A00")

layout(matrix(1:6,6,1,byrow=F))
par(family="serif",cex.axis=1.2,mar=c(1.5,2,0.5,1),oma=c(2.5,3,1,1));
for(i in 1:5){
  tmp=subset(q.dat,site_no==charhar.sites$SITE[i])
  n.mt=sum(is.na(subset(tmp,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$Flow.acft),na.rm=T)
  
  min.q=min(subset(tmp,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$Flow.acft,na.rm=T)
  max.q=max(subset(tmp,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$Flow.acft,na.rm=T)
  # ylim.max=if(nchar(round(max.q,0))==2){round(max.q+max.q*0.25,-1)}else{round(max.q+max.q*0.25,-2)}
  ylim.min=if(min.q<(-10)){floor(min.q+min.q*0.55)}else{floor(min.q+min.q*0.55)}
  ylim.max=if(max.q<150){ceiling(max.q+max.q*0.55)}else{ceiling(max.q+max.q*0.25)}
  ylim.val=c(min.q,ylim.max);by.y=diff(c(min.q,ylim.max))/2;#ylim.max/2;
  ymaj=round(seq(ylim.val[1],ylim.val[2],by.y));ymin=seq(ylim.val[1],ylim.val[2],by.y/2)
  
    # ylim.max=if(max.q<100){100}else{ceiling(max.q+max.q*0.5)}
    # ylim.val=c(0.1,ylim.max);ymaj=log.scale.fun(ylim.val,"major");ymin=log.scale.fun(ylim.val,"minor")
  
  plot(Flow.acft~Date,tmp,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
  abline(h=ymaj,v=xmaj,lty=3,col="grey")
  if(n.mt>0){with(tmp,lines(Date,flow.fill,col="grey",lwd=1,lty=2))}
  with(tmp,pt_line(Date,Flow.acft,2,cols[i],1.5,21,cols[i]))
  
  # if(i==4){axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d/%Y"),line=-0.5)}else{axis_fun(1,xmaj,xmin,NA,line=-0.5)}
  if(min.q<0){abline(h=0)}
  axis_fun(1,xmaj,xmin,NA,line=-0.5)
  axis_fun(2,ymaj,ymin,format(ymaj/1000,nsmall=1),cex.axis=1)
  box(lwd=1)
  with(charhar.sites[i,],mtext(side=3,adj=0,paste(Site.Lab," (USGS Site: ",SITE,")",sep="")),cex=0.75)
  
}

max.q=max(subset(q.dat.xtab,Date%in%seq(TODAY-ddays(30),TODAY+ddays(3),"1 days"))$Tflow,na.rm=T)
ylim.max=ceiling(max.q+max.q*0.5)

ylim.val=c(0,ylim.max);by.y=ylim.max/2;ymaj=seq(ylim.val[1],ylim.val[2],by.y);ymin=seq(ylim.val[1],ylim.val[2],by.y/2)

plot(Tflow~Date,q.dat.xtab,type="n",ylim=ylim.val,xlim=xlim.val,xaxs="i",yaxs="i",xaxt="n",yaxt="n",xlab=NA,ylab=NA)
abline(h=ymaj,v=xmaj,lty=3,col="grey")
with(q.dat.xtab,shaded.range(Date,rep(0,length(Date)),Myakka,lty=1,bg=cols[1]))
with(q.dat.xtab,shaded.range(Date,Myakka,Myakka+BigSlough,lty=1,bg=cols[2]))
with(q.dat.xtab,shaded.range(Date,Myakka+BigSlough,Myakka+BigSlough+Peace,lty=1,bg=cols[3]))
with(q.dat.xtab,shaded.range(Date,Myakka+BigSlough+Peace,Myakka+BigSlough+Peace+Joshua,lty=1,bg=cols[4]))
with(q.dat.xtab,shaded.range(Date,Myakka+BigSlough+Peace+Joshua,Myakka+BigSlough+Peace+Joshua+Shell,lty=1,bg=cols[5]))
axis_fun(1,xmaj,xmin,format(xmaj,"%m/%d/%Y"),line=-0.5)
axis_fun(2,ymaj,ymin,format(ymaj/1000,nsmall=1),cex.axis=1)
box(lwd=1)
mtext(side=3,adj=0,"Daily Total")
mtext(side=2,line=1.25,outer=T,"Discharge (kAc-Ft D\u207B \u00B9)")
mtext(side=1,line=2,"Date (MM/DD/YYYY)")
```

<font size=3><center>Daily discharge into Charlotte Harbor from major rivers and creeks. Data source: USGS. Grey dashed lines between points indicate a potential data gap with values linearly interpolated.</center></font>
<font size=4 color="red"><center>Data are provisional and subject to change.</center></font>

```{r}
q.dat$flow.fill=round(q.dat$flow.fill,1)
q.dat$Q.7d=round(q.dat$Q.7d,1)
q.dat$Q.7d2=with(q.dat,ifelse(N.Q.7d<7,NA,Q.7d))

vars=c("Date","site_no","Site.Lab.y","Flow.acft","Q.7d2")
cap.val="Daily and 7-day moving mean discharge to Charlotte Harbor."

subset(q.dat,Date==YEST)[,vars]%>%
  flextable()%>%
  width(width=c(1,1.25,1.25,1,1))%>%
  align(align="center",part="all")%>%
  colformat_datetime(j=1,fmt_date="%m-%d")%>%
  colformat_double(j=4:5,big.mark="",digits=1,na_str="---")%>%
  merge_v(1)%>%
  fix_border_issues()%>%
  padding(padding=1,part="all")%>%
  fontsize(size=12,part="body")%>%
  fontsize(size=13,part="header")%>%
  bold(part="header")%>%
  set_header_labels("DATE"="Date\n(Month-Day)",
                    "site_no"="USGS Site ID",
                    "Site.Lab.y"="Site Name",
                    "Flow.acft"="Daily Discharge (Ac-Ft d\u207B\u00B9)",
                    "Q.7d2"="Mean 7-d Discharge (Ac-Ft d\u207B\u00B9)")%>%
  add_header_lines(values=cap.val)%>%align(align="center",part="header")%>%fontsize(size=13,part="header")%>%
  footnote(j=1,part="header",ref_symbols = " ",value=as_paragraph(" '---' values indicate missing data either in the current day or past 7-days."))%>%
  font(fontname="Times New Roman",part="all")
```